<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Vaidosa Gestão Lite</title>
  <style>
    :root{
      --bg:#fafbfc;
      --card:#ffffff;
      --txt:#1a1a1a;
      --muted:#64748b;
      --line:#e2e8f0;
      --ok:#10b981;
      --bad:#ef4444;
      --warn:#f59e0b;
      --accent:#b8276c;
      --accent-light:#d94489;
      --shadow: 0 1px 3px rgba(0,0,0,.08), 0 1px 2px rgba(0,0,0,.06);
      --shadow-lg: 0 10px 25px rgba(0,0,0,.08), 0 4px 10px rgba(0,0,0,.05);
    }
    *{box-sizing:border-box;margin:0;padding:0}
    body{
      margin:0;
      font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Helvetica Neue",Arial,sans-serif;
      background:var(--bg);
      color:var(--txt);
      line-height:1.6;
      -webkit-font-smoothing:antialiased
    }
    .sidebar{
      position:fixed;
      left:0;top:0;bottom:0;
      width:260px;
      background:#ffffff;
      border-right:1px solid var(--line);
      box-shadow:var(--shadow);
      z-index:100;
      overflow-y:auto;
      padding:24px 0;
    }
    .sidebar-header{
      padding:0 20px 20px;
      border-bottom:1px solid var(--line);
      margin-bottom:20px;
    }
    .sidebar-header h1{
      font-size:18px;
      margin:0;
      color:var(--txt);
      font-weight:600;
      letter-spacing:-0.02em;
    }
    .sidebar-header .sub{
      color:var(--muted);
      font-size:11px;
      margin-top:4px;
      font-weight:400;
      line-height:1.4;
    }
    nav{display:flex;flex-direction:column;gap:4px;padding:0 12px}
    nav button{
      background:transparent;
      border:none;
      color:#64748b;
      padding:12px 16px;
      border-radius:10px;
      cursor:pointer;
      font-size:14px;
      font-weight:500;
      transition:all .2s ease;
      display:flex;
      align-items:center;
      gap:12px;
      text-align:left;
    }
    nav button svg{
      width:20px;
      height:20px;
      flex-shrink:0;
      opacity:.7;
    }
    nav button:hover{
      background:#f8fafc;
      color:var(--txt);
    }
    nav button:hover svg{opacity:1}
    nav button.active{
      background:linear-gradient(135deg, var(--accent) 0%, var(--accent-light) 100%);
      color:#fff;
      box-shadow:0 2px 8px rgba(184,39,108,.25);
    }
    nav button.active svg{opacity:1;color:#fff}
    .main-container{
      margin-left:260px;
      min-height:100vh;
    }
    .wrap{max-width:1200px;margin:0 auto;padding:24px}
    main{padding:0}
    .grid{display:grid;grid-template-columns:1fr;gap:16px}
    @media(min-width:980px){.grid.cols2{grid-template-columns:1fr 1fr}}
    .card{
      background:var(--card);
      border:1px solid var(--line);
      border-radius:16px;
      padding:20px;
      box-shadow:var(--shadow);
      transition:all .3s ease
    }
    .card:hover{box-shadow:var(--shadow-lg);transform:translateY(-2px)}
    .card h2{font-size:15px;margin:0 0 16px;font-weight:600;color:var(--txt)}
    .row{display:grid;grid-template-columns:1fr;gap:12px}
    @media(min-width:680px){.row.cols2{grid-template-columns:1fr 1fr}.row.cols3{grid-template-columns:1fr 1fr 1fr}}
    label{font-size:13px;color:var(--muted);display:block;margin-bottom:6px;font-weight:500}
    input,select,textarea{
      width:100%;
      padding:11px 14px;
      border-radius:10px;
      border:1.5px solid var(--line);
      background:#fff;
      color:var(--txt);
      outline:none;
      font-size:14px;
      transition:all .2s ease;
      font-family:inherit
    }
    input:focus,select:focus,textarea:focus{
      border-color:var(--accent);
      box-shadow:0 0 0 3px rgba(184,39,108,.08)
    }
    textarea{min-height:90px;resize:vertical}
    .btns{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
    .btn{
      border:1.5px solid var(--line);
      background:#fff;
      color:var(--txt);
      padding:11px 18px;
      border-radius:10px;
      cursor:pointer;
      font-size:14px;
      font-weight:500;
      transition:all .2s ease;
      font-family:inherit
    }
    .btn:hover{transform:translateY(-1px);box-shadow:var(--shadow)}
    .btn.ok{
      background:linear-gradient(135deg, var(--ok) 0%, #059669 100%);
      border-color:var(--ok);
      color:#fff
    }
    .btn.ok:hover{box-shadow:0 4px 12px rgba(16,185,129,.3)}
    .btn.bad{
      background:linear-gradient(135deg, var(--bad) 0%, #dc2626 100%);
      border-color:var(--bad);
      color:#fff
    }
    .btn.bad:hover{box-shadow:0 4px 12px rgba(239,68,68,.3)}
    .btn.warn{
      background:linear-gradient(135deg, var(--warn) 0%, #d97706 100%);
      border-color:var(--warn);
      color:#fff
    }
    .btn.warn:hover{box-shadow:0 4px 12px rgba(245,158,11,.3)}
    .btn.small{padding:7px 12px;font-size:13px}
    .btn.action{
      background:#fff;
      color:#64748b;
      border:1px solid #e2e8f0;
      padding:6px 10px;
      font-size:12px;
      font-weight:500;
      transition:all .2s ease
    }
    .btn.action:hover{
      background:#f8fafc;
      border-color:#cbd5e1;
      color:#334155
    }
    .btn.action.success:hover{
      background:#f0fdf4;
      border-color:#86efac;
      color:#16a34a
    }
    .btn.action.danger:hover{
      background:#fef2f2;
      border-color:#fca5a5;
      color:#dc2626
    }
    .btn:disabled{opacity:.5;cursor:not-allowed}
    .pill{
      display:inline-block;
      padding:4px 12px;
      border:1.5px solid var(--line);
      border-radius:999px;
      font-size:12px;
      color:var(--muted);
      background:#fff;
      font-weight:500
    }
    .kpi{display:grid;grid-template-columns:1fr;gap:12px}
    @media(min-width:680px){.kpi{grid-template-columns:repeat(4,1fr)}}
    .kpi.six{grid-template-columns:1fr}
    @media(min-width:680px){.kpi.six{grid-template-columns:repeat(3,1fr)}}
    .kpi .box{
      background:linear-gradient(135deg, #fff 0%, #fafbfc 100%);
      border:1.5px solid var(--line);
      border-radius:14px;
      padding:16px;
      transition:all .3s ease;
      position:relative;
      overflow:hidden
    }
    .kpi .box::before{
      content:'';
      position:absolute;
      top:0;right:0;
      width:60px;height:60px;
      background:var(--accent);
      opacity:.05;
      border-radius:0 14px 0 100%
    }
    .kpi .box:hover{transform:translateY(-2px);box-shadow:var(--shadow-lg)}
    .kpi .box .t{color:var(--muted);font-size:12px;font-weight:500;text-transform:uppercase;letter-spacing:.05em}
    .kpi .box .v{font-size:20px;margin-top:8px;font-weight:700;color:var(--txt)}
    table{width:100%;border-collapse:collapse}
    thead{background:#fafbfc}
    tbody tr{transition:background .2s ease}
    tbody tr:nth-child(even){background:#fafbfc}
    tbody tr:hover{background:#f1f5f9}
    th,td{border-bottom:1px solid var(--line);padding:12px 10px;text-align:left;font-size:13px;vertical-align:middle}
    th{color:var(--muted);font-weight:600;text-transform:uppercase;font-size:11px;letter-spacing:.05em}
    td input[type="number"]{min-width:85px;padding:8px 10px;font-size:13px;text-align:right}
    
    /* Larguras específicas da tabela de produtos */
    #prodTable td:nth-child(2){white-space:normal !important;word-wrap:break-word !important}
    #prodTable td:nth-child(2) div{word-wrap:break-word !important;overflow-wrap:break-word !important}
    
    .muted{color:var(--muted)}
    .right{text-align:right}
    .small{font-size:12px}
    .hide{display:none !important}
    .sep{height:1px;background:var(--line);margin:14px 0}
    .toast{
      position:fixed;right:20px;bottom:20px;
      background:#fff;
      border:1.5px solid var(--line);
      padding:14px 16px;
      border-radius:14px;
      max-width:420px;
      box-shadow:var(--shadow-lg);
      animation:slideIn .3s ease
    }
    @keyframes slideIn{from{transform:translateX(100%);opacity:0}to{transform:translateX(0);opacity:1}}
    .toast b{display:block;margin-bottom:4px;color:var(--txt);font-weight:600}
    .warnBox{
      border:1.5px solid #fbbf24;
      background:linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
      padding:12px 16px;
      border-radius:12px;
      color:#78350f;
      font-size:13px
    }
    .okBox{
      border:1.5px solid #34d399;
      background:linear-gradient(135deg, #d1fae5 0%, #a7f3d0 100%);
      padding:12px 16px;
      border-radius:12px;
      color:#064e3b;
      font-size:13px
    }
    .badgeAccent{
      display:inline-block;
      padding:3px 10px;
      border-radius:999px;
      border:none;
      background:linear-gradient(135deg, var(--accent) 0%, var(--accent-light) 100%);
      color:#fff;
      font-size:11px;
      font-weight:600;
      text-transform:uppercase;
      letter-spacing:.05em
    }
    .dangerBox{
      border:1.5px solid #f87171;
      background:linear-gradient(135deg, #fee2e2 0%, #fecaca 100%);
      padding:12px 16px;
      border-radius:12px;
      color:#7f1d1d;
      font-size:13px
    }
    .infoBox{
      border:1.5px solid #3b82f6;
      background:linear-gradient(135deg, #eff6ff 0%, #dbeafe 100%);
      padding:12px 16px;
      border-radius:12px;
      color:#1e40af;
      font-size:13px;
      margin-bottom: 16px;
    }
    .inline{display:flex;gap:12px;align-items:center;flex-wrap:wrap}
    .chk{display:flex;gap:10px;align-items:center}
    .chk input{width:auto;cursor:pointer}
    .modal{
      position:fixed;inset:0;
      background:rgba(0,0,0,.5);
      backdrop-filter:blur(4px);
      display:flex;align-items:center;justify-content:center;
      z-index:999;
      animation:fadeIn .2s ease
    }
    @keyframes fadeIn{from{opacity:0}to{opacity:1}}
    .modalBox{
      background:#fff;
      border-radius:16px;
      padding:24px;
      max-width:560px;
      width:90%;
      max-height:85vh;
      overflow:auto;
      box-shadow:0 20px 50px rgba(0,0,0,.2);
      animation:scaleIn .3s ease
    }
    @keyframes scaleIn{from{transform:scale(.9);opacity:0}to{transform:scale(1);opacity:1}}
    .modalBox h2{font-size:18px;font-weight:600;margin-bottom:16px;color:var(--txt)}
    .statusPago{color:var(--ok);font-weight:600}
    .statusParcial{color:var(--warn);font-weight:600}
    .statusAberto{color:var(--bad);font-weight:600}
  
    /* Tela de Login */
    #loginScreen {
      display: flex;
      align-items: center;
      justify-content: center;
      min-height: 100vh;
      background: linear-gradient(135deg, var(--accent) 0%, var(--accent-light) 100%);
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      z-index: 9999;
    }
    .login-box {
      background: white;
      padding: 48px;
      border-radius: 16px;
      box-shadow: var(--shadow-lg);
      text-align: center;
      max-width: 400px;
      width: 90%;
    }
    .login-box h1 {
      font-size: 24px;
      margin-bottom: 8px;
      color: var(--txt);
    }
    .login-box p {
      color: var(--muted);
      font-size: 14px;
      margin-bottom: 32px;
    }
    .google-btn {
      background: white;
      border: 1px solid var(--line);
      padding: 12px 24px;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 12px;
      transition: all 0.2s ease;
      width: 100%;
    }
    .google-btn:hover {
      background: var(--bg);
      box-shadow: var(--shadow);
    }
    #appContainer.hide { display: none; }
    #loginScreen.hide { display: none; }

  </style>

  <!-- Firebase SDK v9 COMPAT -->
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>

</head>
<body>

  <div id="loginScreen">
    <div class="login-box">
      <h1>Vaidosa Gestão</h1>
      <p>Sistema completo de gestão para moda plus size</p>
      <button class="google-btn" onclick="loginWithGoogle()">
        <svg style="width:20px;height:20px" viewBox="0 0 24 24">
          <path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/>
          <path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/>
          <path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/>
          <path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/>
        </svg>
        Entrar com Google
      </button>
    </div>
  </div>
  <div id="appContainer" class="hide">

<aside class="sidebar">
  <div class="sidebar-header">
    <h1>Vaidosa Gestão <span class="badgeAccent">Premium</span></h1>
    <div class="sub">Sistema completo de gestão para moda plus size</div>
  </div>
  <nav>
    <button data-tab="venda" class="active">
      <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 3h2l.4 2M7 13h10l4-8H5.4M7 13L5.4 5M7 13l-2.293 2.293c-.63.63-.184 1.707.707 1.707H17m0 0a2 2 0 100 4 2 2 0 000-4zm-8 2a2 2 0 11-4 0 2 2 0 014 0z"/></svg>
      Caixa / PDV
    </button>
    <button data-tab="produtos">
      <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 7h.01M7 3h5c.512 0 1.024.195 1.414.586l7 7a2 2 0 010 2.828l-7 7a2 2 0 01-2.828 0l-7-7A1.994 1.994 0 013 12V7a4 4 0 014-4z"/></svg>
      Produtos
    </button>
    <button data-tab="estoque">
      <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4"/></svg>
      Estoque
    </button>
    <button data-tab="clientes">
      <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"/></svg>
      Clientes
    </button>
    <button data-tab="vendedores">
      <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"/></svg>
      Equipe
    </button>
    <button data-tab="financeiro">
      <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
      Financeiro
    </button>
    <button data-tab="relatorios">
      <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"/></svg>
      Relatórios
    </button>
    <button data-tab="backup">
      <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 7v10c0 2.21 3.582 4 8 4s8-1.79 8-4V7M4 7c0 2.21 3.582 4 8 4s8-1.79 8-4M4 7c0-2.21 3.582-4 8-4s8 1.79 8 4m0 5c0 2.21-3.582 4-8 4s-8-1.79-8-4"/></svg>
      Backup & Dados
    </button>
  </nav>
</aside>

<div class="main-container">
<main class="wrap">
  <section id="tab-home" class="grid hide">
    <div class="card">
      <h2>Resumo rápido</h2>
      <div class="kpi" id="kpi"></div>
      <div class="sep"></div>
      <div class="muted small">
        Dica: leitor USB de código de barras funciona como teclado. Deixe o cursor no campo Barcode e bipa.
      </div>
    </div>
    <div class="card">
      <h2>Status</h2>
      <div id="statusBox" class="okBox small"></div>
    </div>
  </section>

  <section id="tab-estoque" class="grid cols2 hide">
    <div class="card">
      <h2>Entrada de estoque (balanço)</h2>
      <div class="warnBox small" style="margin-bottom:10px">
        Lançamento de entrada por barcode. Soma no estoque e registra movimentação.
      </div>

      <div class="row cols2">
        <div>
          <label>Barcode</label>
          <input id="s_barcode" placeholder="Bipe no leitor ou digite" />
        </div>
        <div>
          <label>Quantidade</label>
          <input id="s_qty" type="number" step="1" value="1" />
        </div>
      </div>

      <div class="row cols2">
        <div>
          <label>Atualizar custo (opcional)</label>
          <input id="s_cost" type="number" step="0.01" placeholder="Se quiser trocar custo do produto" />
        </div>
        <div>
          <label>Observação</label>
          <input id="s_note" placeholder="Ex: reposição, fornecedor..." />
        </div>
      </div>

      <div class="btns">
        <button class="btn ok" id="btnStockIn">Lançar entrada</button>
        <button class="btn" id="btnStockManual">+ Entrada manual</button>
        <button class="btn" id="btnClearStock">Limpar</button>
      </div>

      <div class="sep"></div>
      <div id="stockPreview" class="muted small">Bipe um produto para ver detalhes.</div>
    </div>

    <div class="card">
      <h2>Movimentações recentes</h2>
      <div style="overflow:auto;max-height:540px">
        <table>
          <thead>
            <tr><th>Data</th><th>Tipo</th><th>Barcode</th><th>Produto</th><th class="right">Qtd</th><th class="right">Estoque após</th></tr>
          </thead>
          <tbody id="stockMoves"></tbody>
        </table>
      </div>
    <div class="card" style="grid-column:1/-1">
      <h2>Estoque atual (visão geral)</h2>
      <div class="warnBox small" style="margin-bottom:10px">
        Relatório do que você tem agora, com filtros por modelo, categoria e grade.
      </div>

      <div class="row cols3">
        <div>
          <label>Buscar modelo</label>
          <input id="st_q" placeholder="Ex: Tulipa, Jeans, Bermuda..." />
        </div>
        <div>
          <label>Categoria</label>
          <select id="st_cat">
            <option value="">Todas</option>
          </select>
        </div>
        <div>
          <label>Grade</label>
          <select id="st_size">
            <option value="">Todas</option>
            <option value="G1">G1</option>
            <option value="G2">G2</option>
            <option value="G3">G3</option>
            <option value="G4">G4</option>
            <option value="G5">G5</option>
          </select>
        </div>
      </div>

      <div class="sep"></div>

      <div class="kpi six" id="stockKpi">
        <div class="box"><div class="t">Peças (qtd)</div><div class="v" id="st_kpi_qty">0</div></div>
        <div class="box"><div class="t">Valor em custo</div><div class="v" id="st_kpi_cost">R$ 0,00</div></div>
        <div class="box"><div class="t">Valor em venda</div><div class="v" id="st_kpi_sell">R$ 0,00</div></div>
      </div>

      <div class="sep"></div>

      <div style="overflow:auto">
        <table>
          <thead>
            <tr>
              <th>Modelo</th>
              <th>Categoria</th>
              <th>Tecido</th>
              <th class="right">G1</th>
              <th class="right">G2</th>
              <th class="right">G3</th>
              <th class="right">G4</th>
              <th class="right">G5</th>
              <th class="right">Total</th>
              <th class="right">Custo unit</th>
              <th class="right">Venda unit</th>
              <th class="right">Custo total</th>
              <th class="right">Venda total</th>
            </tr>
          </thead>
          <tbody id="stockReportBody"></tbody>
        </table>
      </div>
      <div class="muted small" style="margin-top:10px" id="stockReportHint"></div>
    </div>

  </section>

  <section id="tab-produtos" class="hide">
    <div class="wrap" style="max-width:1400px">
      <div class="card">
      <h2>Cadastrar produto</h2>

      <div class="infoBox">
        <b>Códigos VF automáticos:</b> O sistema gera VF000001, VF000002... para cada grade.
      </div>
      <div class="row cols2">
        <div>
          <label>SKU interno (opcional)</label>
          <input id="p_sku" placeholder="Ex: CALCA-001-G3" />
        </div>
        <div></div>
      </div>

      <div class="row cols2">
        <div>
          <label>Nome do produto</label>
          <input id="p_name" placeholder="Ex: Calça Jeans" />
        </div>
        <div>
          <label>Categoria</label>
          <select id="p_cat">
            <option value="">Selecione...</option>
            <option value="Calça">Calça</option>
            <option value="Blusa">Blusa</option>
            <option value="Short">Short</option>
            <option value="Camisa">Camisa</option>
            <option value="Vestido">Vestido</option>
            <option value="Conjunto">Conjunto</option>
            <option value="Saia">Saia</option>
            <option value="Macaquinho">Macaquinho</option>
            <option value="outro">Outro (digitar)</option>
          </select>
          <input id="p_cat_outro" placeholder="Digite categoria..." style="display:none;margin-top:8px" />
        </div>
      </div>

      <div class="row cols2">
        <div>
          <label>Preço de custo (R$)</label>
          <input id="p_cost" type="number" step="0.01" placeholder="0,00" />
        </div>
        <div>
          <label>Preço de venda (R$)</label>
          <input id="p_price" type="number" step="0.01" placeholder="0,00" />
        </div>
      </div>

      <div class="row cols2">
        <div>
          <label>Tecido (opcional)</label>
          <select id="p_fabric">
            <option value="">Selecione...</option>
            <option value="Viscose">Viscose</option>
            <option value="Viscosinho">Viscosinho</option>
            <option value="Linho">Linho</option>
            <option value="Crepe">Crepe</option>
            <option value="Duna">Duna</option>
            <option value="Alfaiataria">Alfaiataria</option>
            <option value="Moletinho">Moletinho</option>
            <option value="Jeans">Jeans</option>
            <option value="outro">Outro (digitar)</option>
          </select>
          <input id="p_fabric_outro" placeholder="Digite tecido..." style="display:none;margin-top:8px" />
        </div>
        <div>
          <label>Observação (opcional)</label>
          <input id="p_note" placeholder="Ex: cor, detalhe..." />
        </div>
      </div>

      <div class="sep"></div>
      <h2>Estoque por grade</h2>
      <div class="warnBox small" style="margin-bottom:12px">
        Informe a quantidade de cada tamanho. Pode deixar 0 se quiser apenas cadastrar o produto agora (sem estoque).
      </div>

      <div class="row cols3">
        <div>
          <label>G1 (qtd)</label>
          <input id="p_stock_g1" type="number" step="1" min="0" value="0" />
        </div>
        <div>
          <label>G2 (qtd)</label>
          <input id="p_stock_g2" type="number" step="1" min="0" value="0" />
        </div>
        <div>
          <label>G3 (qtd)</label>
          <input id="p_stock_g3" type="number" step="1" min="0" value="0" />
        </div>
      </div>

      <div class="row cols2">
        <div>
          <label>G4 (qtd)</label>
          <input id="p_stock_g4" type="number" step="1" min="0" value="0" />
        </div>
        <div>
          <label>G5 (qtd)</label>
          <input id="p_stock_g5" type="number" step="1" min="0" value="0" />
        </div>
      </div>

      <div class="btns">
        <button class="btn ok" id="btnAddProduct">Gerar códigos e salvar</button>
        <button class="btn" id="btnClearProduct">Limpar</button>
      </div>

      <div class="sep"></div>
      <div class="muted small">
        <b>Como funciona:</b> Preencha os dados do produto e informe a quantidade de cada grade. O sistema criará automaticamente um produto para cada tamanho com estoque maior que zero. Todas as grades compartilham o mesmo código de barras - ao bipar no PDV, você escolhe o tamanho.
      </div>
    </div>

    <div class="card" style="margin-top:20px">
      <h2>Buscar e editar</h2>
      <div class="row cols2">
        <div>
          <label>Buscar (nome, barcode, SKU)</label>
          <input id="p_search" placeholder="Digite para filtrar..." />
        </div>
        <div>
          <label>Filtrar por grade</label>
          <select id="p_filter_size">
            <option value="">Todas</option>
            <option value="G1">G1</option><option value="G2">G2</option><option value="G3">G3</option><option value="G4">G4</option><option value="G5">G5</option>
          </select>
        </div>
      </div>
      <div class="sep"></div>
      <div style="overflow-x:auto;max-height:540px">
        <table style="width:100%;min-width:1090px">
          <thead>
            <tr>
              <th style="width:8%">Barcode</th>
              <th style="width:30%">Produto</th>
              <th style="width:15%">Categoria</th>
              <th style="width:13%">Tecido</th>
              <th style="width:5%">Grade</th>
              <th class="right" style="width:7%">Estoque</th>
              <th class="right" style="width:8%">Venda</th>
              <th class="right" style="width:8%">Custo</th>
              <th style="width:6%"></th>
            </tr>
          </thead>
          <tbody id="prodTable"></tbody>
        </table>
      </div>
      <div class="sep"></div>
      <div class="btns">
        <button class="btn warn" id="btnEditProduct" disabled>Editar selecionado</button>
        <button class="btn bad" id="btnDeleteProduct" disabled>Excluir selecionado</button>
        <span class="pill" id="selectedProductPill">Nenhum selecionado</span>
      </div>
    </div>
    </div>
  </section>

  <section id="tab-clientes" class="grid cols2 hide">
    <div class="card">
      <h2>Cadastrar cliente</h2>

      <div class="row cols2">
        <div>
          <label>Nome / Razão social</label>
          <input id="c_name" placeholder="Nome do cliente" />
        </div>
        <div>
          <label>Telefone (WhatsApp)</label>
          <input id="c_phone" placeholder="DDD + número" />
        </div>
      </div>

      <div class="row cols2">
        <div>
          <label>CNPJ (opcional)</label>
          <input id="c_cnpj" placeholder="00.000.000/0000-00" />
        </div>
        <div>
          <label>CPF (opcional)</label>
          <input id="c_cpf" placeholder="Somente se usar" />
        </div>
      </div>

      <div class="row cols2">
        <div>
          <label>Cidade/UF (opcional)</label>
          <input id="c_city" placeholder="Ex: Goiânia/GO" />
        </div>
        <div>
          <label>Observação (opcional)</label>
          <input id="c_note" placeholder="Ex: preferências, grade mais usada..." />
        </div>
      </div>

      <div class="row cols2">
        <div>
          <label>Trocas usadas (controle)</label>
          <input id="c_trocas" type="number" step="1" min="0" value="0" />
        </div>
        <div class="btns" style="align-items:end">
          <button class="btn ok" id="btnAddClient">Salvar cliente</button>
          <button class="btn" id="btnClearClient">Limpar</button>
        </div>
      </div>
    </div>

    <div class="card">
      <h2>Clientes e histórico</h2>
      <div class="row cols2">
        <div>
          <label>Buscar cliente</label>
          <input id="c_search" placeholder="Nome ou telefone..." />
        </div>
        <div>
          <label>Selecionado</label>
          <div style="display:flex;gap:8px;align-items:center">
            <div class="pill" id="selectedClientPill">Nenhum</div>
            <button class="btn small ok" id="btnEditClient" disabled>Editar</button>
          </div>
        </div>
      </div>
      <div class="sep"></div>
      <div style="overflow:auto;max-height:260px">
        <table>
          <thead>
            <tr><th>Cliente</th><th>Telefone</th><th class="right">Trocas</th><th class="right">Compras</th><th class="right">Bruto</th><th class="right">Líquido</th></tr>
          </thead>
          <tbody id="clientTable"></tbody>
        </table>
      </div>
      <div class="sep"></div>
      <div>
        <h2>Histórico do cliente</h2>
        <div id="clientHistory" class="muted small">Selecione um cliente para ver as compras.</div>
      </div>
    </div>
  </section>

  <section id="tab-vendedores" class="grid cols2 hide">
    <div class="card">
      <h2>Cadastrar vendedor</h2>

      <div class="row cols2">
        <div>
          <label>Nome do vendedor</label>
          <input id="v_name" placeholder="Ex: Maria Silva" />
        </div>
        <div>
          <label>Telefone (opcional)</label>
          <input id="v_phone" placeholder="DDD + número" />
        </div>
      </div>

      <div class="row cols2">
        <div>
          <label>Observação (opcional)</label>
          <input id="v_note" placeholder="Ex: turno, comissão..." />
        </div>
        <div class="btns" style="align-items:end">
          <button class="btn ok" id="btnAddVendedor">Salvar vendedor</button>
          <button class="btn" id="btnClearVendedor">Limpar</button>
        </div>
      </div>
    </div>

    <div class="card">
      <h2>Vendedores cadastrados</h2>
      <div style="overflow:auto;max-height:540px">
        <table>
          <thead>
            <tr><th>Vendedor</th><th>Telefone</th><th>Obs</th><th></th></tr>
          </thead>
          <tbody id="vendedorTable"></tbody>
        </table>
      </div>
    </div>
  </section>

  <section id="tab-venda" class="grid cols2">
    <div class="card">
      <h2>Venda (PDV)</h2>

      <div class="row cols3">
        <div>
          <label>Cliente</label>
          <select id="sale_client"></select>
        </div>

        <div>
          <label>Vendedor</label>
          <select id="sale_vendedor"></select>
        </div>

        <div>
          <label>Canal</label>
          <select id="sale_channel">
            <option value="Loja">Loja</option>
            <option value="Trafego">Tráfego pago</option>
            <option value="WhatsApp">WhatsApp</option>
            <option value="Instagram">Instagram</option>
            <option value="Indicacao">Indicação</option>
            <option value="Outro">Outro</option>
          </select>
        </div>
      </div>

      <div class="row cols2" style="margin-top:10px">
        <div>
          <label>Tipo</label>
          <select id="sale_kind">
            <option value="Venda">Venda</option>
            <option value="Troca">Troca</option>
          </select>
        </div>

        <div>
          <label>Pagamento</label>
          <select id="sale_pay">
            <option value="PIX">PIX</option>
            <option value="Dinheiro">Dinheiro</option>
            <option value="CartaoAVista">Cartão (à vista)</option>
            <option value="CartaoParcelado">Cartão (parcelado 2x a 6x)</option>
            <option value="Misto">Misto</option>
          </select>
        </div>
      </div>

      <div id="trocaWarn" class="dangerBox small hide" style="margin-top:10px">
        Atenção: este cliente já tem troca registrada. Pela regra, não pode fazer 2ª troca.
      </div>

      <div class="row cols2" style="margin-top:10px">
        <div id="instWrap" class="hide">
          <label>Parcelas</label>
          <select id="sale_inst">
            <option value="2">2x</option>
            <option value="3">3x</option>
            <option value="4">4x</option>
            <option value="5">5x</option>
            <option value="6">6x</option>
          </select>
        </div>
      </div>

      <div class="sep"></div>

      <h2>Adicionar itens</h2>

      <div class="row cols2">
        <div>
          <label>Barcode (bipar)</label>
          <input id="sale_barcode" placeholder="Bipe e aperte Enter" />
        </div>
        <div>
          <button class="btn" id="btnManualAdd" style="margin-top:22px">+ Adicionar manual (buscar produto)</button>
        </div>
      </div>

      <div class="row cols2">
        <div>
          <label>Desconto (R$)</label>
          <input id="sale_discount" type="number" step="0.01" value="0" />
        </div>
        <div class="chk" style="margin-top:22px">
          <input id="overrideTroca" type="checkbox" />
          <label for="overrideTroca" style="margin:0">Liberar 2ª troca (exceção)</label>
        </div>
      </div>

      <div class="row">
        <div>
          <label>Observação</label>
          <input id="sale_note" placeholder="Ex: combinado, referência..." />
        </div>
      </div>

      <div class="sep"></div>

      <div style="overflow:auto;max-height:340px">
        <table>
          <thead>
            <tr><th>Item</th><th>Grade</th><th class="right">Qtd</th><th class="right">Preço</th><th class="right">Total</th><th></th></tr>
          </thead>
          <tbody id="saleItems"></tbody>
        </table>
      </div>

      <div class="sep"></div>

      <div class="kpi six">
        <div class="box"><div class="t">Subtotal</div><div class="v" id="sale_sub">R$ 0,00</div></div>
        <div class="box"><div class="t">Desconto</div><div class="v" id="sale_disc">R$ 0,00</div></div>
        <div class="box"><div class="t">Total (bruto)</div><div class="v" id="sale_total">R$ 0,00</div></div>
        <div class="box"><div class="t">Taxas do cartão</div><div class="v" id="sale_fee">R$ 0,00</div></div>
        <div class="box"><div class="t">Líquido a receber</div><div class="v" id="sale_net">R$ 0,00</div></div>
        <div class="box"><div class="t">Lucro estimado</div><div class="v" id="sale_profit">R$ 0,00</div></div>
      </div>

      <div class="sep"></div>

      <div class="btns">
        <button class="btn ok" id="btnFinalize">Lançar Venda (Pendente)</button>
        <button class="btn" id="btnClearSale">Limpar</button>
      </div>

      <div class="sep"></div>
      <div class="muted small">
        Regra do cartão aplicada: taxa fixa 2,99% + adicional do parcelado (2x a 6x). Para PIX/Dinheiro/Misto, taxa automática fica zerada.
      </div>
    </div>

    <div class="card">
      <h2>Vendas recentes</h2>
      <div style="overflow:auto;max-height:540px">
        <table>
          <thead>
            <tr><th>Data</th><th>Cliente</th><th>Canal</th><th>Status</th><th class="right">Bruto</th><th class="right">Pago</th><th class="right">Líquido</th></tr>
          </thead>
          <tbody id="salesTable"></tbody>
        </table>
      </div>
    </div>
  </section>

  <section id="tab-relatorios" class="grid hide">
    <div class="card">
      <h2>Relatório mensal</h2>

      <div class="row cols3">
        <div>
          <label>Mês</label>
          <input id="r_month" type="month" />
        </div>
        <div>
          <label>Filtrar por canal</label>
          <select id="r_channel">
            <option value="">Todos</option>
            <option value="Loja">Loja</option>
            <option value="Trafego">Tráfego pago</option>
            <option value="WhatsApp">WhatsApp</option>
            <option value="Instagram">Instagram</option>
            <option value="Indicacao">Indicação</option>
            <option value="Outro">Outro</option>
          </select>
        </div>
        <div>
          <label>Filtrar por pagamento</label>
          <select id="r_pay">
            <option value="">Todos</option>
            <option value="PIX">PIX</option>
            <option value="Dinheiro">Dinheiro</option>
            <option value="CartaoAVista">Cartão (à vista)</option>
            <option value="CartaoParcelado">Cartão (parcelado)</option>
            <option value="Misto">Misto</option>
          </select>
        </div>
      </div>

      <div class="btns" style="margin-top:10px">
        <button class="btn ok" id="btnRunReport">Gerar</button>
        <button class="btn warn" id="btnExportReportPDF">Exportar PDF</button>
      </div>

      <div class="sep"></div>

      <div class="kpi" id="reportKPI"></div>

      <div class="sep"></div>

      <h2>Top produtos (quantidade)</h2>
      <div style="overflow:auto;max-height:320px">
        <table>
          <thead><tr><th>Produto</th><th>Barcode</th><th>Grade</th><th class="right">Qtd</th><th class="right">Bruto</th><th class="right">Líquido</th></tr></thead>
          <tbody id="topProducts"></tbody>
        </table>
      </div>

      <div class="sep"></div>
      <h2>Resumo por canal</h2>
      <div style="overflow:auto;max-height:260px">
        <table>
          <thead><tr><th>Canal</th><th class="right">Vendas</th><th class="right">Bruto</th><th class="right">Líquido</th><th class="right">Lucro</th></tr></thead>
          <tbody id="byChannel"></tbody>
        </table>
      </div>
    </div>
  </section>

  <section id="tab-financeiro" class="hide">
    <div class="wrap" style="max-width:1400px">
      
      <div class="card">
        <h2>Dashboard Financeiro - Visão Geral</h2>
        
        <div class="row cols3">
          <div>
            <div style="background:#f0fdf4;border:1.5px solid #86efac;border-radius:12px;padding:16px">
              <div style="color:#16a34a;font-size:12px;font-weight:600;text-transform:uppercase;margin-bottom:8px">Entradas do Mês</div>
              <div id="fin_dashEntradas" style="font-size:28px;font-weight:700;color:#15803d">R$ 0,00</div>
            </div>
          </div>
          <div>
            <div style="background:#fef2f2;border:1.5px solid #fca5a5;border-radius:12px;padding:16px">
              <div style="color:#dc2626;font-size:12px;font-weight:600;text-transform:uppercase;margin-bottom:8px">Saídas do Mês</div>
              <div id="fin_dashSaidas" style="font-size:28px;font-weight:700;color:#b91c1c">R$ 0,00</div>
            </div>
          </div>
          <div>
            <div id="fin_dashSaldoBox" style="background:#eff6ff;border:1.5px solid #93c5fd;border-radius:12px;padding:16px">
              <div style="color:#2563eb;font-size:12px;font-weight:600;text-transform:uppercase;margin-bottom:8px">Saldo do Mês</div>
              <div id="fin_dashSaldo" style="font-size:28px;font-weight:700;color:#1d4ed8">R$ 0,00</div>
            </div>
          </div>
        </div>

        <div class="sep"></div>

        <div class="row cols2">
          <div class="card" style="background:#fafbfc">
            <h3 style="font-size:14px;font-weight:600;margin:0 0 16px">Despesas por Categoria</h3>
            <canvas id="chartCategorias" style="max-height:280px"></canvas>
          </div>
          <div class="card" style="background:#fafbfc">
            <h3 style="font-size:14px;font-weight:600;margin:0 0 16px">Evolução Mensal (6 meses)</h3>
            <canvas id="chartEvolucao" style="max-height:280px"></canvas>
          </div>
        </div>
      </div>

      <div class="sep"></div>

      <div class="card">
        <h2>Fluxo de Caixa - Visão Mensal</h2>
        
        <div class="row cols3">
          <div>
            <label>Mês/Ano</label>
            <select id="fin_fluxoMes">
              <option value="">Selecione...</option>
            </select>
          </div>
          <div>
            <label>Tipo</label>
            <select id="fin_fluxoTipo">
              <option value="">Todas</option>
              <option value="pagar">Contas a Pagar</option>
              <option value="receber">Contas a Receber</option>
            </select>
          </div>
          <div>
            <label>Status</label>
            <select id="fin_fluxoStatus">
              <option value="">Todos</option>
              <option value="pendente">Pendentes</option>
              <option value="pago">Pagas/Recebidas</option>
              <option value="atrasado">Atrasadas</option>
            </select>
          </div>
        </div>

        <div class="sep"></div>

        <div class="kpi">
          <div class="box">
            <div class="t">Entradas do Mês</div>
            <div class="v" id="fin_fluxoEntradas" style="color:#10b981">R$ 0,00</div>
          </div>
          <div class="box">
            <div class="t">Saídas do Mês</div>
            <div class="v" id="fin_fluxoSaidas" style="color:#ef4444">R$ 0,00</div>
          </div>
          <div class="box">
            <div class="t">Saldo do Mês</div>
            <div class="v" id="fin_fluxoSaldo">R$ 0,00</div>
          </div>
          <div class="box">
            <div class="t">Total de Contas</div>
            <div class="v" id="fin_fluxoTotal">0</div>
          </div>
        </div>

        <div class="sep"></div>

        <div style="overflow-x:auto;max-height:500px">
          <table>
            <thead>
              <tr>
                <th style="width:90px">Data</th>
                <th style="width:30%">Descrição</th>
                <th style="width:100px">Tipo</th>
                <th style="width:20%">Categoria/Cliente</th>
                <th class="right" style="width:100px">Valor</th>
                <th style="width:120px">Status</th>
              </tr>
            </thead>
            <tbody id="fin_tabelaFluxo"></tbody>
          </table>
        </div>
      </div>

      <div class="sep"></div>

      <div class="card">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px">
          <h2 style="margin:0">Contas a Pagar</h2>
          <button class="btn ok" id="btnNovaPagar">+ Nova Conta a Pagar</button>
        </div>
        
        <div class="row cols3">
          <div>
            <label>Filtrar por status</label>
            <select id="fin_filtroPagarStatus">
              <option value="">Todas</option>
              <option value="pendente">Pendentes</option>
              <option value="pago">Pagas</option>
              <option value="atrasado">Atrasadas</option>
            </select>
          </div>
          <div>
            <label>Filtrar por categoria</label>
            <select id="fin_filtroPagarCategoria">
              <option value="">Todas</option>
            </select>
          </div>
          <div>
            <label>Buscar</label>
            <input id="fin_buscaPagar" placeholder="Descrição..." />
          </div>
        </div>

        <div class="sep"></div>
        
        <div style="overflow-x:auto;max-height:400px">
          <table>
            <thead>
              <tr>
                <th>Descrição</th>
                <th>Categoria</th>
                <th>Valor</th>
                <th>Vencimento</th>
                <th>Status</th>
                <th>Recorrência</th>
                <th></th>
              </tr>
            </thead>
            <tbody id="fin_tabelaPagar"></tbody>
          </table>
        </div>
      </div>

      <div class="sep"></div>

      <div class="card">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px">
          <h2 style="margin:0">Contas a Receber</h2>
          <button class="btn ok" id="btnNovaReceber">+ Nova Conta a Receber</button>
        </div>
        
        <div class="row cols3">
          <div>
            <label>Filtrar por status</label>
            <select id="fin_filtroReceberStatus">
              <option value="">Todas</option>
              <option value="pendente">Pendentes</option>
              <option value="recebido">Recebidas</option>
              <option value="atrasado">Atrasadas</option>
            </select>
          </div>
          <div>
            <label>Filtrar por cliente</label>
            <select id="fin_filtroReceberCliente">
              <option value="">Todos</option>
            </select>
          </div>
          <div>
            <label>Buscar</label>
            <input id="fin_buscaReceber" placeholder="Descrição..." />
          </div>
        </div>

        <div class="sep"></div>
        
        <div style="overflow-x:auto;max-height:400px">
          <table>
            <thead>
              <tr>
                <th>Descrição</th>
                <th>Cliente</th>
                <th>Valor</th>
                <th>Vencimento</th>
                <th>Status</th>
                <th></th>
              </tr>
            </thead>
            <tbody id="fin_tabelaReceber"></tbody>
          </table>
        </div>
      </div>

      <div class="sep"></div>

      <div class="card">
        <h2>Histórico de Pagamentos e Recebimentos</h2>
        <div class="infoBox" style="margin-bottom:16px">
          Todas as contas que já foram pagas ou recebidas aparecem aqui. Você pode cancelar um pagamento e reabrir a conta.
        </div>
        
        <div class="row cols3">
          <div>
            <label>Filtrar por mês</label>
            <select id="fin_historicoMes">
              <option value="">Todos os meses</option>
            </select>
          </div>
          <div>
            <label>Filtrar por tipo</label>
            <select id="fin_historicoTipo">
              <option value="">Todas</option>
              <option value="pagar">Contas Pagas</option>
              <option value="receber">Contas Recebidas</option>
            </select>
          </div>
          <div>
            <label>Buscar</label>
            <input id="fin_historicoBusca" placeholder="Descrição..." />
          </div>
        </div>

        <div class="sep"></div>

        <div style="overflow-x:auto;max-height:500px">
          <table>
            <thead>
              <tr>
                <th>Data Pagamento</th>
                <th>Descrição</th>
                <th>Tipo</th>
                <th>Categoria/Cliente</th>
                <th class="right">Valor</th>
                <th></th>
              </tr>
            </thead>
            <tbody id="fin_tabelaHistorico"></tbody>
          </table>
        </div>
      </div>

      <div class="sep"></div>

      <div class="card">
        <h2>Categorias</h2>
        <div class="infoBox" style="margin-bottom:16px">
          Organize suas despesas e receitas por categorias para facilitar o controle financeiro.
        </div>
        
        <div class="row cols2">
          <div>
            <label>Nova Categoria</label>
            <input id="fin_novaCategoriaNome" placeholder="Ex: Marketing" />
          </div>
          <div>
            <label>Tipo</label>
            <select id="fin_novaCategoriaTipo">
              <option value="despesa">Despesa</option>
              <option value="receita">Receita</option>
            </select>
          </div>
        </div>
        <div class="btns">
          <button class="btn ok" id="btnAddCategoria">Adicionar Categoria</button>
        </div>

        <div class="sep"></div>

        <div class="row cols2">
          <div>
            <h3 style="font-size:14px;font-weight:600;margin:0 0 12px">Categorias de Despesas</h3>
            <div id="fin_listaDespesas" style="display:flex;flex-wrap:wrap;gap:8px"></div>
          </div>
          <div>
            <h3 style="font-size:14px;font-weight:600;margin:0 0 12px">Categorias de Receitas</h3>
            <div id="fin_listaReceitas" style="display:flex;flex-wrap:wrap;gap:8px"></div>
          </div>
        </div>
      </div>

    </div>
  </section>

  <section id="tab-backup" class="grid cols2 hide">
    <div class="card">
      <h2>Backup automático (Edge)</h2>
      <div class="warnBox small">
        Isso salva um arquivo JSON automaticamente na pasta que você escolher (ideal: OneDrive). Protege contra PC dar pau.
      </div>
      <div class="sep"></div>

      <div class="row">
        <div class="btns">
          <button class="btn ok" id="btnAutoBackupEnable">Ativar backup automático</button>
          <button class="btn bad" id="btnAutoBackupDisable" disabled>Desativar</button>
          <button class="btn" id="btnAutoBackupNow" disabled>Salvar agora</button>
        </div>
        <div class="sep"></div>
        <div class="small">
          <div><b>Status:</b> <span id="autoBackupStatus">Verificando...</span></div>
          <div class="muted"><span id="autoBackupHint"></span></div>
          <div class="muted"><span id="autoBackupLast"></span></div>
        </div>

        <div class="sep"></div>
        <div class="chk">
          <input id="blockSecondSwap" type="checkbox" checked />
          <label for="blockSecondSwap" style="margin:0">Bloquear 2ª troca automaticamente</label>
        </div>
        <div class="muted small">
          Se desmarcar, o sistema vai permitir trocar de novo, mas o contador continua registrando.
        </div>
        
        <div class="sep"></div>
        <h2>Contador de códigos VF</h2>
        <div class="infoBox">
          <b>Último código gerado:</b> <span id="lastCodeGenerated">Nenhum ainda</span>
        </div>
        <button class="btn warn" id="btnResetCounter">Redefinir contador</button>
      </div>
    </div>

    <div class="card">
      <h2>Backup manual</h2>
      <div class="warnBox small">
        Use se quiser enviar para WhatsApp ou guardar em pendrive.
      </div>
      <div class="sep"></div>
      <div class="btns">
        <button class="btn ok" id="btnExport">Baixar backup (JSON)</button>
      </div>

      <div class="sep"></div>

      <h2>Importar backup</h2>
      <div class="warnBox small">
        Importar substitui os dados atuais.
      </div>
      <div class="sep"></div>
      <input type="file" id="fileImport" accept="application/json" />
      <div class="btns" style="margin-top:10px">
        <button class="btn warn" id="btnImport">Importar</button>
        <button class="btn bad" id="btnWipe">Zerar tudo</button>
      </div>
    </div>
  </section>
</main>
</div>

<div id="toast" class="toast hide"></div>

<div id="modalGrade" class="modal hide">
  <div class="modalBox">
    <h2>Escolher grade</h2>
    <div id="modalGradeInfo" class="muted small"></div>
    <div class="sep"></div>
    <div class="row cols3">
      <button class="btn" data-grade="G1">G1</button>
      <button class="btn" data-grade="G2">G2</button>
      <button class="btn" data-grade="G3">G3</button>
      <button class="btn" data-grade="G4">G4</button>
      <button class="btn" data-grade="G5">G5</button>
    </div>
    <div class="sep"></div>
    <button class="btn bad" id="btnCancelGrade">Cancelar</button>
  </div>
</div>

<div id="modalManual" class="modal hide">
  <div class="modalBox">
    <h2>Adicionar produto manual</h2>
    <div class="row">
      <div>
        <label>Buscar produto por nome</label>
        <input id="manual_search" placeholder="Digite nome do produto..." />
      </div>
    </div>
    <div class="sep"></div>
    <div style="max-height:320px;overflow:auto">
      <table>
        <thead>
          <tr><th>Produto</th><th>Barcode</th><th>Grade</th><th class="right">Estoque</th><th class="right">Preço</th><th></th></tr>
        </thead>
        <tbody id="manualProductTable"></tbody>
      </table>
    </div>
    <div class="sep"></div>
    <button class="btn bad" id="btnCancelManual">Cancelar</button>
  </div>
</div>

<div id="modalPayments" class="modal hide">
  <div class="modalBox">
    <h2>Gerenciar pagamentos</h2>
    <div id="paymentSaleInfo" class="small"></div>
    <div class="sep"></div>
    
    <div class="row cols2">
      <div>
        <label>Valor do pagamento (R$)</label>
        <input id="payment_value" type="number" step="0.01" placeholder="0,00" />
      </div>
      <div>
        <label>Data</label>
        <input id="payment_date" type="date" />
      </div>
    </div>
    
    <div class="row cols2">
      <div>
        <label>Forma de pagamento</label>
        <select id="payment_method">
          <option value="PIX">PIX</option>
          <option value="Dinheiro">Dinheiro</option>
          <option value="Debito">Débito</option>
          <option value="Credito">Crédito</option>
        </select>
      </div>
      <div id="payment_installments_container">
        <label>Parcelas</label>
        <select id="payment_installments">
          <option value="1">1x</option>
          <option value="2">2x</option>
          <option value="3">3x</option>
          <option value="4">4x</option>
          <option value="5">5x</option>
          <option value="6">6x</option>
        </select>
      </div>
    </div>
    
    <div class="row">
      <div>
        <label>Observação (opcional)</label>
        <input id="payment_note" placeholder="Ex: PIX confirmado..." />
      </div>
    </div>
    
    <div class="btns" style="margin-top:10px">
      <button class="btn ok" id="btnAddPayment">Registrar pagamento</button>
    </div>
    
    <div class="sep"></div>
    <h2>Histórico de pagamentos</h2>
    <div style="max-height:240px;overflow:auto">
      <table>
        <thead>
          <tr><th>Data</th><th>Método</th><th class="right">Valor</th><th class="right">Taxa</th><th class="right">Líquido</th></tr>
        </thead>
        <tbody id="paymentHistory"></tbody>
      </table>
    </div>
    
    <div class="sep"></div>
    <button class="btn" id="btnClosePayments">Fechar</button>
  </div>
</div>

<div id="modalStockManual" class="modal hide">
  <div class="modalBox">
    <h2>Entrada manual de estoque</h2>
    <div class="row">
      <div>
        <label>Buscar produto por nome</label>
        <input id="stock_manual_search" placeholder="Digite nome do produto..." />
      </div>
    </div>
    <div class="sep"></div>
    <div style="max-height:320px;overflow:auto">
      <table>
        <thead>
          <tr><th>Produto</th><th>Grade</th><th class="right">Estoque atual</th><th class="right">Custo</th><th></th></tr>
        </thead>
        <tbody id="stockManualProductTable"></tbody>
      </table>
    </div>
    <div class="sep"></div>
    <button class="btn bad" id="btnCancelStockManual">Cancelar</button>
  </div>
</div>

<div id="modalStockEntry" class="modal hide">
  <div class="modalBox">
    <h2>Confirmar entrada</h2>
    <div id="stockEntryInfo" class="small"></div>
    <div class="sep"></div>
    
    <div class="row cols2">
      <div>
        <label>Quantidade</label>
        <input id="stock_entry_qty" type="number" step="1" min="1" value="1" />
      </div>
      <div>
        <label>Atualizar custo (opcional)</label>
        <input id="stock_entry_cost" type="number" step="0.01" placeholder="Deixe vazio para manter" />
      </div>
    </div>
    
    <div class="row">
      <div>
        <label>Observação</label>
        <input id="stock_entry_note" placeholder="Ex: reposição, fornecedor..." />
      </div>
    </div>
    
    <div class="btns" style="margin-top:10px">
      <button class="btn ok" id="btnConfirmStockEntry">Confirmar entrada</button>
      <button class="btn" id="btnCancelStockEntry">Cancelar</button>
    </div>
  </div>
</div>

<div id="modalContaPagar" class="modal" style="display:none">
  <div class="modalBox" style="max-width:600px">
    <h2 id="modalPagarTitulo">Nova Conta a Pagar</h2>
    <input type="hidden" id="editPagarId" />
    
    <div class="row cols2">
      <div>
        <label>Descrição</label>
        <input id="pagarDescricao" placeholder="Ex: Aluguel Loja" />
      </div>
      <div>
        <label>Categoria</label>
        <select id="pagarCategoria"></select>
      </div>
    </div>

    <div class="row cols2">
      <div>
        <label>Valor (R$)</label>
        <input id="pagarValor" type="number" step="0.01" placeholder="0,00" />
      </div>
      <div>
        <label>Data Vencimento</label>
        <input id="pagarVencimento" type="date" />
      </div>
    </div>

    <div class="row cols2">
      <div>
        <label>Recorrência</label>
        <select id="pagarRecorrencia">
          <option value="unica">Única (paga 1 vez)</option>
          <option value="semanal">Semanal</option>
          <option value="mensal">Mensal</option>
        </select>
      </div>
      <div id="divPagarParcelas" style="display:none">
        <label>Total de Parcelas</label>
        <input id="pagarParcelas" type="number" min="1" value="1" />
      </div>
    </div>

    <div>
      <label>Observação (opcional)</label>
      <input id="pagarObs" placeholder="Ex: Pago toda segunda-feira" />
    </div>

    <div class="sep"></div>
    <div class="btns">
      <button class="btn ok" id="btnSalvarPagar">Salvar</button>
      <button class="btn" id="btnCancelarPagar">Cancelar</button>
    </div>
  </div>
</div>

<div id="modalContaReceber" class="modal" style="display:none">
  <div class="modalBox" style="max-width:600px">
    <h2 id="modalReceberTitulo">Nova Conta a Receber</h2>
    <input type="hidden" id="editReceberId" />
    
    <div class="row cols2">
      <div>
        <label>Descrição</label>
        <input id="receberDescricao" placeholder="Ex: Venda à prazo" />
      </div>
      <div>
        <label>Cliente (opcional)</label>
        <select id="receberCliente">
          <option value="">Nenhum</option>
        </select>
      </div>
    </div>

    <div class="row cols2">
      <div>
        <label>Valor (R$)</label>
        <input id="receberValor" type="number" step="0.01" placeholder="0,00" />
      </div>
      <div>
        <label>Data Vencimento</label>
        <input id="receberVencimento" type="date" />
      </div>
    </div>

    <div>
      <label>Forma de Recebimento</label>
      <select id="receberForma">
        <option value="PIX">PIX</option>
        <option value="Cartão Crédito">Cartão Crédito</option>
        <option value="Cartão Débito">Cartão Débito</option>
        <option value="Dinheiro">Dinheiro</option>
      </select>
    </div>

    <div>
      <label>Observação (opcional)</label>
      <input id="receberObs" placeholder="Detalhes..." />
    </div>

    <div class="sep"></div>
    <div class="btns">
      <button class="btn ok" id="btnSalvarReceber">Salvar</button>
      <button class="btn" id="btnCancelarReceber">Cancelar</button>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>


  <script>
    /* ═══════════════════════════════════════
       FIREBASE - AGUARDAR CARREGAMENTO
    ═══════════════════════════════════════ */
    
    // Esperar Firebase carregar
    function waitForFirebase() {
      return new Promise((resolve) => {
        if (typeof firebase !== 'undefined') {
          resolve();
        } else {
          const checkInterval = setInterval(() => {
            if (typeof firebase !== 'undefined') {
              clearInterval(checkInterval);
              resolve();
            }
          }, 100);
        }
      });
    }

    // Variáveis globais
    let auth, firestoreDb;
    
    // Inicializar quando Firebase estiver pronto
    
// Desabilita o botão até o Firebase estar pronto (evita clique antes do auth/firestore existirem)
const __googleBtn = document.querySelector('.google-btn');
if (__googleBtn) __googleBtn.disabled = true;

// Inicialização única do Firebase (promessa global, usada também no login)
const firebaseInitPromise = waitForFirebase().then(() => {
    if (!firebase.apps.length) {
        firebase.initializeApp(firebaseConfig);
    }
    auth = firebase.auth();
    firestoreDb = firebase.firestore();

    if (__googleBtn) __googleBtn.disabled = false;
}).catch((err) => {
    console.error("Erro ao inicializar Firebase:", err);
    if (__googleBtn) __googleBtn.disabled = true;
    alert("Erro ao inicializar o sistema. Verifique as credenciais do Firebase e tente novamente.");
});

async function loginWithGoogle() {
      const provider = new firebase.auth.GoogleAuthProvider();
      try {
        await firebaseInitPromise;
        if (!auth) throw new Error('Firebase Auth não inicializado');
        const result = await auth.signInWithPopup(provider);
        console.log('✅ Login:', result.user.email);
      } catch (error) {
        console.error('❌ Erro login:', error);
        alert('Erro ao fazer login. Tente novamente.');
      }
    }
    
    // Logout
    async function logoutUser() {
      try {
        await auth.signOut();
        console.log('✅ Logout OK');
      } catch (error) {
        console.error('❌ Erro logout:', error);
      }
    }
    
    // Mostrar/Ocultar telas
    function showLogin() {
      document.getElementById('loginScreen').classList.remove('hide');
      document.getElementById('appContainer').classList.add('hide');
    }
    
    function showApp() {
      document.getElementById('loginScreen').classList.add('hide');
      document.getElementById('appContainer').classList.remove('hide');
    }
    
    // Salvar no Firestore
    async function saveToFirestore(collection, data) {
      if (!currentUser) return false;
      try {
        await firestoreDb.collection('users').doc(currentUser.uid).collection(collection).doc('data').set(data, { merge: true });
        console.log(`✅ ${collection} salvo`);
        return true;
      } catch (error) {
        console.error(`❌ Erro ao salvar ${collection}:`, error);
        return false;
      }
    }
    
    // Carregar do Firestore
    async function loadFromFirestore(collection) {
      if (!currentUser) return null;
      try {
        const doc = await firestoreDb.collection('users').doc(currentUser.uid).collection(collection).doc('data').get();
        if (doc.exists) {
          console.log(`✅ ${collection} carregado`);
          return doc.data();
        }
        return null;
      } catch (error) {
        console.error(`❌ Erro ao carregar ${collection}:`, error);
        return null;
      }
    }
    
    // Carregar todos os dados
    async function loadAllDataFromFirestore() {
      console.log('🔄 Carregando dados...');
      try {
        const mainData = await loadFromFirestore('main');
        const settingsData = await loadFromFirestore('settings');
        const counterData = await loadFromFirestore('counter');
        
        if (mainData && mainData.db) {
          db = mainData.db;
        }
        if (settingsData && settingsData.settings) {
          settings = settingsData.settings;
        }
        if (counterData && counterData.counter !== undefined) {
          const stored = counterData.counter;
          localStorage.setItem(CODE_COUNTER_KEY, String(stored));
        }
        
        console.log('✅ Dados carregados');
        renderAll();
      } catch (error) {
        console.error('❌ Erro ao carregar:', error);
      }
    }
    
    // Listener de autenticação agora está dentro do waitForFirebase()
    
    // Renderizar tudo
    function renderAll() {
      try {
        renderHome();
        renderProducts();
        renderClients();
        if(typeof renderVendedores === 'function') renderVendedores();
        renderStock();
        if(typeof renderReportDefaults === 'function') renderReportDefaults();
        if(document.getElementById("lastCodeGenerated")){
          document.getElementById("lastCodeGenerated").textContent = getLastGeneratedCode();
        }
        if(document.getElementById("blockSecondSwap")){
          document.getElementById("blockSecondSwap").checked = settings.blockSecondSwap;
        }
      } catch (error) {
        console.error('❌ Erro ao renderizar:', error);
      }
    }

  /* ═══════════════════════════════════════
     BANCO LOCAL (RESTO DO CÓDIGO)
  ═══════════════════════════════════════ */
  /* =========================
     BANCO LOCAL
  ========================= */
  const KEY = "vaidosa_lite_v4";
  const SETTINGS_KEY = "vaidosa_settings_v1";
  const CODE_COUNTER_KEY = "vaidosa_code_counter";

  function loadDB(){
    const raw = localStorage.getItem(KEY);
    if(!raw){
      const db = { 
        products:[], 
        clients:[], 
        vendedores:[], 
        sales:[], 
        stockMoves:[],
        // MÓDULO FINANCEIRO
        contas:[], // contas a pagar/receber (com recorrência)
        movimentacoes:[], // registro de cada pagamento/recebimento
        categorias:[] // categorias de despesas/receitas
      };
      localStorage.setItem(KEY, JSON.stringify(db));
      return db;
    }
    try{ 
      const parsed = JSON.parse(raw);
      if(!parsed.vendedores) parsed.vendedores = [];
      // Adicionar estruturas financeiras se não existirem
      if(!parsed.contas) parsed.contas = [];
      if(!parsed.movimentacoes) parsed.movimentacoes = [];
      if(!parsed.categorias) parsed.categorias = [];
      return parsed;
    }catch{ 
      return { 
        products:[], 
        clients:[], 
        vendedores:[], 
        sales:[], 
        stockMoves:[],
        contas:[],
        movimentacoes:[],
        categorias:[]
      }; 
    }
  }

  function loadCodeCounter(){
    const raw = localStorage.getItem(CODE_COUNTER_KEY);
    if(!raw) return 0;
    try{ return parseInt(raw) || 0; }catch{ return 0; }
  }

  function saveCodeCounter(n){
    localStorage.setItem(CODE_COUNTER_KEY, String(n));
  }

  function generateNextCode(){
    let counter = loadCodeCounter();
    counter++;
    saveCodeCounter(counter);
    return "VF" + String(counter).padStart(6, "0");
  }

  function getLastGeneratedCode(){
    const counter = loadCodeCounter();
    if(counter === 0) return "Nenhum ainda";
    return "VF" + String(counter).padStart(6, "0");
  }

  function loadSettings(){
    const raw = localStorage.getItem(SETTINGS_KEY);
    const base = { blockSecondSwap:true };
    if(!raw){ localStorage.setItem(SETTINGS_KEY, JSON.stringify(base)); return base; }
    try{
      const s = JSON.parse(raw);
      return { ...base, ...s };
    }catch{
      localStorage.setItem(SETTINGS_KEY, JSON.stringify(base));
      return base;
    }
  }

  async function saveSettings(s){
    localStorage.setItem(SETTINGS_KEY, JSON.stringify(s));
    await saveToFirestore('settings', { settings: s });
  }

  function uid(prefix="id"){ return prefix + "_" + Math.random().toString(16).slice(2) + "_" + Date.now().toString(16); }
  function nowISO(){ return new Date().toISOString(); }
  function toNum(v){ const n = Number(v); return Number.isFinite(n)?n:0; }
  function fmtBRL(n){
    const v = Number(n||0);
    return v.toLocaleString("pt-BR",{style:"currency",currency:"BRL"});
  }
  function escapeHtml(s){ return String(s??"").replace(/[&<>"']/g,m=>({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;" }[m])); }

  let db = loadDB();
  let settings = loadSettings();

  let selectedProductId = null;
  let selectedClientId = null;
  let editingClientId = null; // Controle de edição
  let currentSale = { items:[], finalizedSaleId:null };
  let pendingBarcodeForGrade = null;
  let currentPaymentSaleId = null;
  let currentStockEntryProductId = null;

  /* =========================
     TAXAS DO CARTÃO
  ========================= */
  const CARD_FEES = {
    base: 0.0299,
    installments: { 2: 0.0227, 3: 0.0285, 4: 0.0347, 5: 0.0406, 6: 0.0464 }
  };

  function calcCardFee(total, pay, inst){
    total = toNum(total);
    let pct = 0;
    if(pay === "CartaoAVista") pct = CARD_FEES.base;
    if(pay === "CartaoParcelado"){
      const i = Number(inst || 2);
      pct = CARD_FEES.base + (CARD_FEES.installments[i] || 0);
    }
    const feeValue = total * pct;
    const net = total - feeValue;
    return { pct, feeValue, net };
  }

  function findProductByBarcode(code){
    code = String(code||"").trim();
    if(!code) return null;
    return db.products.find(p=>String(p.barcode).trim()===code) || null;
  }
  
  function findProductsByBarcode(code){
    code = String(code||"").trim();
    if(!code) return [];
    return db.products.filter(p=>String(p.barcode).trim()===code);
  }
  
  function findClientById(id){ return db.clients.find(c=>c.id===id)||null; }
  function findVendedorById(id){ return db.vendedores.find(v=>v.id===id)||null; }

  /* =========================
     TOAST
  ========================= */
  function toast(title,msg){
    const t = document.getElementById("toast");
    t.innerHTML = `<b>${escapeHtml(title)}</b><div class="small muted">${escapeHtml(msg||"")}</div>`;
    t.classList.remove("hide");
    setTimeout(()=>t.classList.add("hide"), 3400);
  }

  /* =========================
     AUTO BACKUP (EDGE)
  ========================= */
  const IDB_NAME = "vaidosa_auto_backup_db";
  const IDB_STORE = "handles";
  const IDB_KEY = "backupFileHandle";

  let autoBackupHandle = null;
  let autoBackupLastAt = null;
  let backupDebounceTimer = null;
  let backupInFlight = false;

  function idbOpen(){
    return new Promise((resolve,reject)=>{
      const req = indexedDB.open(IDB_NAME, 1);
      req.onupgradeneeded = ()=>{
        const dbi = req.result;
        if(!dbi.objectStoreNames.contains(IDB_STORE)) dbi.createObjectStore(IDB_STORE);
      };
      req.onsuccess = ()=>resolve(req.result);
      req.onerror = ()=>reject(req.error);
    });
  }

  async function idbGet(key){
    const dbi = await idbOpen();
    return new Promise((resolve,reject)=>{
      const tx = dbi.transaction(IDB_STORE, "readonly");
      const store = tx.objectStore(IDB_STORE);
      const req = store.get(key);
      req.onsuccess = ()=>resolve(req.result || null);
      req.onerror = ()=>reject(req.error);
    });
  }

  async function idbSet(key,val){
    const dbi = await idbOpen();
    return new Promise((resolve,reject)=>{
      const tx = dbi.transaction(IDB_STORE, "readwrite");
      const store = tx.objectStore(IDB_STORE);
      const req = store.put(val, key);
      req.onsuccess = ()=>resolve(true);
      req.onerror = ()=>reject(req.error);
    });
  }

  async function idbDel(key){
    const dbi = await idbOpen();
    return new Promise((resolve,reject)=>{
      const tx = dbi.transaction(IDB_STORE, "readwrite");
      const store = tx.objectStore(IDB_STORE);
      const req = store.delete(key);
      req.onsuccess = ()=>resolve(true);
      req.onerror = ()=>reject(req.error);
    });
  }

  async function ensurePermission(handle, writable){
    if(!handle) return false;
    const opts = writable ? { mode:"readwrite" } : {};
    try{
      if(handle.queryPermission){
        let p = await handle.queryPermission(opts);
        if(p === "granted") return true;
        p = await handle.requestPermission(opts);
        return p === "granted";
      }
      return true;
    }catch{
      return false;
    }
  }

  async function initAutoBackup(){
    const statusEl = document.getElementById("autoBackupStatus");
    const hintEl = document.getElementById("autoBackupHint");
    const lastEl = document.getElementById("autoBackupLast");
    const btnOn = document.getElementById("btnAutoBackupEnable");
    const btnOff = document.getElementById("btnAutoBackupDisable");
    const btnNow = document.getElementById("btnAutoBackupNow");

    if(!("showSaveFilePicker" in window)){
      statusEl.textContent = "Indisponível";
      hintEl.textContent = "Este navegador não suporta backup automático. Use Edge ou Chrome no Windows.";
      lastEl.textContent = "";
      btnOn.disabled = true;
      btnOff.disabled = true;
      btnNow.disabled = true;
      return;
    }

    const saved = await idbGet(IDB_KEY);
    if(saved){
      autoBackupHandle = saved;
      const ok = await ensurePermission(autoBackupHandle, true);
      if(ok){
        statusEl.textContent = "Ativo";
        hintEl.textContent = "Arquivo configurado. O sistema salva automaticamente quando há alterações.";
        btnOn.disabled = true;
        btnOff.disabled = false;
        btnNow.disabled = false;
      }else{
        statusEl.textContent = "Precisa de permissão";
        hintEl.textContent = "Clique em 'Salvar agora' para conceder permissão, ou ative novamente.";
        btnOn.disabled = false;
        btnOff.disabled = false;
        btnNow.disabled = false;
      }
    }else{
      autoBackupHandle = null;
      statusEl.textContent = "Desativado";
      hintEl.textContent = "Clique em 'Ativar backup automático' e salve o arquivo dentro do OneDrive.";
      lastEl.textContent = "";
      btnOn.disabled = false;
      btnOff.disabled = true;
      btnNow.disabled = true;
    }
  }

  function setAutoBackupUI(lastMsg){
    const statusEl = document.getElementById("autoBackupStatus");
    const hintEl = document.getElementById("autoBackupHint");
    const lastEl = document.getElementById("autoBackupLast");
    const btnOn = document.getElementById("btnAutoBackupEnable");
    const btnOff = document.getElementById("btnAutoBackupDisable");
    const btnNow = document.getElementById("btnAutoBackupNow");

    if(autoBackupHandle){
      statusEl.textContent = "Ativo";
      hintEl.textContent = "Arquivo configurado. O sistema salva automaticamente quando há alterações.";
      btnOn.disabled = true;
      btnOff.disabled = false;
      btnNow.disabled = false;
      if(lastMsg) lastEl.textContent = lastMsg;
      return;
    }
    statusEl.textContent = "Desativado";
    hintEl.textContent = "Clique em 'Ativar backup automático' e salve o arquivo dentro do OneDrive.";
    lastEl.textContent = "";
    btnOn.disabled = false;
    btnOff.disabled = true;
    btnNow.disabled = true;
  }

  async function chooseAutoBackupFile(){
    try{
      const handle = await window.showSaveFilePicker({
        suggestedName: "vaidosa_backup_auto.json",
        types: [{ description:"JSON", accept:{ "application/json":[".json"] } }]
      });
      const ok = await ensurePermission(handle, true);
      if(!ok) return toast("Permissão negada","Não consegui permissão para gravar no arquivo.");
      autoBackupHandle = handle;
      await idbSet(IDB_KEY, handle);
      setAutoBackupUI("Configurado. Primeiro backup será salvo automaticamente.");
      toast("Ativado","Backup automático configurado.");
      await backupNow("Ativação");
    }catch(e){
      toast("Cancelado","Você não selecionou o arquivo.");
    }
  }

  async function disableAutoBackup(){
    autoBackupHandle = null;
    await idbDel(IDB_KEY);
    setAutoBackupUI();
    toast("Desativado","Backup automático foi desligado.");
  }

  function scheduleBackup(reason){
    if(!autoBackupHandle) return;
    if(backupDebounceTimer) clearTimeout(backupDebounceTimer);
    backupDebounceTimer = setTimeout(()=>backupNow(reason||"Alteração"), 700);
  }

  async function backupNow(reason){
    if(!autoBackupHandle) return;
    if(backupInFlight) return;
    backupInFlight = true;

    try{
      const ok = await ensurePermission(autoBackupHandle, true);
      if(!ok){
        toast("Sem permissão","Clique em 'Salvar agora' para conceder permissão.");
        backupInFlight = false;
        return;
      }
      const writable = await autoBackupHandle.createWritable();
      const payload = JSON.stringify(db, null, 2);
      await writable.write(payload);
      await writable.close();

      autoBackupLastAt = new Date();
      const msg = `Último auto-backup: ${autoBackupLastAt.toLocaleString("pt-BR")} (${reason||"ok"})`;
      const lastEl = document.getElementById("autoBackupLast");
      if(lastEl) lastEl.textContent = msg;
    }catch(e){
      toast("Falhou","Não consegui gravar o backup automático. Use backup manual e reative.");
    }finally{
      backupInFlight = false;
    }
  }

  /* =========================
     SAVE DB
  ========================= */
  async function saveDB(reason){
    console.log(`💾 Salvando: ${reason}`);
    localStorage.setItem(KEY, JSON.stringify(db));
    await saveToFirestore('main', { db: db });
    
    const counter = loadCodeCounter();
    await saveToFirestore('counter', { counter: counter });
    
    scheduleBackup(reason);
  }

  /* =========================
     TABS
  ========================= */
  const tabs = ["venda","clientes","produtos","estoque","vendedores","financeiro","relatorios","backup","home"];
  document.querySelectorAll("nav button").forEach(btn=>{
    btn.addEventListener("click", ()=>{
      const t = btn.dataset.tab;
      setTab(t);
    });
  });

  function setTab(t){
    document.querySelectorAll("nav button").forEach(b=>b.classList.toggle("active", b.dataset.tab===t));
    tabs.forEach(x=> document.getElementById("tab-"+x).classList.toggle("hide", x!==t) );

    if(t==="home") renderHome();
    if(t==="produtos"){ selectedProductId=null; renderProducts(); }
    if(t==="clientes"){ 
      selectedClientId=null; 
      editingClientId=null;
      document.getElementById("btnAddClient").textContent = "Salvar cliente";
      document.getElementById("btnEditClient").disabled = true;
      renderClients(); 
    }
    if(t==="vendedores") renderVendedores();
    if(t==="financeiro") renderFinanceiro();
    if(t==="estoque") renderStock();
    if(t==="venda") renderSale();
    if(t==="relatorios") renderReportDefaults();
    if(t==="backup"){
      renderStatus();
      document.getElementById("blockSecondSwap").checked = !!settings.blockSecondSwap;
      initAutoBackup();
    }
  }

  /* =========================
     STATUS + HOME
  ========================= */
  function renderStatus(){
    const box = document.getElementById("statusBox");
    const usingHttps = location.protocol === "https:";
    const localFile = location.protocol === "file:";
    const msg = [];
    if(usingHttps) msg.push("Rodando em HTTPS. Bom para iPhone/iPad.");
    else if(localFile) msg.push("Arquivo local (file://). Funciona no PC. Para usar no iPhone/iPad com mais estabilidade, publique em HTTPS.");
    else msg.push("Rodando sem HTTPS. Para iPhone/iPad, publique em HTTPS.");

    msg.push("Dados ficam salvos neste navegador. Backup automático protege contra PC dar pau.");
    msg.push(autoBackupHandle ? "Backup automático: ativo." : "Backup automático: desativado (ative na aba Backup).");

    box.innerHTML = msg.map(m=>`• ${escapeHtml(m)}`).join("<br>");
  }

  function renderHome(){
    renderStatus();
    const k = document.getElementById("kpi");
    const totalProducts = db.products.length;
    const totalClients = db.clients.length;
    const stockTotal = db.products.reduce((a,p)=>a+toNum(p.stock),0);

    const sales30 = db.sales.filter(s=>{
      const d = new Date(s.date);
      return (Date.now()-d.getTime()) <= 30*24*3600*1000;
    });
    const bruto30 = sales30.reduce((a,s)=>a+toNum(s.totalBruto),0);
    const liquido30 = sales30.reduce((a,s)=>a+toNum(s.netReceived||0),0);

    k.innerHTML = `
      <div class="box"><div class="t">Produtos</div><div class="v">${totalProducts}</div></div>
      <div class="box"><div class="t">Clientes</div><div class="v">${totalClients}</div></div>
      <div class="box"><div class="t">Peças em estoque (qtd)</div><div class="v">${stockTotal}</div></div>
      <div class="box"><div class="t">Últimos 30 dias (líquido)</div><div class="v">${fmtBRL(liquido30)}</div></div>
    `;
  }

  /* =========================
     PRODUTOS
  ========================= */
  
  // Controle do SELECT de Categoria
  let editingProductId = null; // Variável para controlar edição
  
  document.getElementById("p_cat").addEventListener("change", ()=>{
    const val = document.getElementById("p_cat").value;
    const outroField = document.getElementById("p_cat_outro");
    if(val === "outro"){
      outroField.style.display = "block";
      outroField.focus();
    } else {
      outroField.style.display = "none";
      outroField.value = "";
    }
  });

  // Controle do SELECT de Tecido
  document.getElementById("p_fabric").addEventListener("change", ()=>{
    const val = document.getElementById("p_fabric").value;
    const outroField = document.getElementById("p_fabric_outro");
    if(val === "outro"){
      outroField.style.display = "block";
      outroField.focus();
    } else {
      outroField.style.display = "none";
      outroField.value = "";
    }
  });
  
  document.getElementById("btnAddProduct").addEventListener("click", ()=>{
    const name = document.getElementById("p_name").value.trim();
    if(!name) return toast("Faltou nome","Preencha o nome do produto.");

    const baseSku = document.getElementById("p_sku").value.trim();
    
    // Pegar categoria (do select ou do campo "outro")
    let cat = document.getElementById("p_cat").value.trim();
    if(cat === "outro") cat = document.getElementById("p_cat_outro").value.trim();
    
    const cost = Math.max(0, toNum(document.getElementById("p_cost").value));
    const price = Math.max(0, toNum(document.getElementById("p_price").value));
    const note = document.getElementById("p_note").value.trim();
    
    // Pegar tecido (do select ou do campo "outro")
    let fabric = document.getElementById("p_fabric").value.trim();
    if(fabric === "outro") fabric = document.getElementById("p_fabric_outro").value.trim();

    // ═══════════════════════════════════════
    // MODO EDIÇÃO: Salvar alterações
    // ═══════════════════════════════════════
    if(editingProductId){
      const p = db.products.find(x => x.id === editingProductId);
      if(!p) return toast("Erro","Produto não encontrado.");
      
      // Atualizar dados
      p.sku = baseSku ? `${baseSku}-${p.size}` : p.sku;
      p.name = name;
      p.cat = cat;
      p.fabric = fabric;
      p.cost = cost;
      p.price = price;
      p.note = note;
      
      // Atualizar estoque do tamanho específico
      const newStock = Math.max(0, Math.floor(toNum(document.getElementById(`p_stock_${p.size.toLowerCase()}`).value)));
      p.stock = newStock;
      
      saveDB("Produto editado");
      toast("Salvo!","Alterações aplicadas com sucesso.");
      clearProductForm();
      renderProducts();
      renderHome();
      return;
    }

    // ═══════════════════════════════════════
    // MODO CRIAÇÃO: Gerar novos produtos
    // ═══════════════════════════════════════
    const grades = {
      G1: Math.max(0, Math.floor(toNum(document.getElementById("p_stock_g1").value))),
      G2: Math.max(0, Math.floor(toNum(document.getElementById("p_stock_g2").value))),
      G3: Math.max(0, Math.floor(toNum(document.getElementById("p_stock_g3").value))),
      G4: Math.max(0, Math.floor(toNum(document.getElementById("p_stock_g4").value))),
      G5: Math.max(0, Math.floor(toNum(document.getElementById("p_stock_g5").value)))
    };

    let created = 0;
    const codes = [];
    for(const [size, stock] of Object.entries(grades)){
      const code = generateNextCode();
      codes.push(code);
      const sku = baseSku ? `${baseSku}-${size}` : "";
      
      const p = {
        id: uid("p"),
        barcode: code,
        sku,
        name,
        cat,
        fabric,
        size,
        cost,
        price,
        stock,
        note
      };

      db.products.unshift(p);
      created++;
    }

    saveDB("Produto em lote");
    toast("Códigos gerados",`${created} produto(s) criado(s): ${codes.join(", ")}`);
    clearProductForm();
    renderProducts();
    renderHome();
  });

  document.getElementById("btnClearProduct").addEventListener("click", clearProductForm);
  function clearProductForm(){
    ["p_sku","p_name","p_note","p_cost","p_price"].forEach(id=>document.getElementById(id).value="");
    ["p_stock_g1","p_stock_g2","p_stock_g3","p_stock_g4","p_stock_g5"].forEach(id=>document.getElementById(id).value="0");
    
    // Resetar selects
    document.getElementById("p_cat").value = "";
    document.getElementById("p_fabric").value = "";
    document.getElementById("p_cat_outro").value = "";
    document.getElementById("p_fabric_outro").value = "";
    document.getElementById("p_cat_outro").style.display = "none";
    document.getElementById("p_fabric_outro").style.display = "none";
    
    // Resetar modo de edição
    editingProductId = null;
    document.getElementById("btnAddProduct").textContent = "Gerar códigos e salvar";
    document.getElementById("btnAddProduct").className = "btn ok";
  }

  document.getElementById("p_search").addEventListener("input", renderProducts);
  document.getElementById("p_filter_size").addEventListener("change", renderProducts);

  // Botão EDITAR produto
  document.getElementById("btnEditProduct").addEventListener("click", ()=>{
    if(!selectedProductId) return;
    const p = db.products.find(x=>x.id===selectedProductId);
    if(!p) return;

    // Preencher formulário com dados do produto
    document.getElementById("p_sku").value = p.sku || "";
    document.getElementById("p_name").value = p.name || "";
    document.getElementById("p_cost").value = p.cost || "";
    document.getElementById("p_price").value = p.price || "";
    document.getElementById("p_note").value = p.note || "";
    
    // Categoria: verificar se existe no select ou usar "outro"
    const catSelect = document.getElementById("p_cat");
    const catOptions = Array.from(catSelect.options).map(opt => opt.value);
    if(catOptions.includes(p.cat)){
      catSelect.value = p.cat;
      document.getElementById("p_cat_outro").style.display = "none";
    } else {
      catSelect.value = "outro";
      document.getElementById("p_cat_outro").value = p.cat || "";
      document.getElementById("p_cat_outro").style.display = "block";
    }
    
    // Tecido: verificar se existe no select ou usar "outro"
    const fabricSelect = document.getElementById("p_fabric");
    const fabricOptions = Array.from(fabricSelect.options).map(opt => opt.value);
    if(fabricOptions.includes(p.fabric)){
      fabricSelect.value = p.fabric;
      document.getElementById("p_fabric_outro").style.display = "none";
    } else {
      fabricSelect.value = "outro";
      document.getElementById("p_fabric_outro").value = p.fabric || "";
      document.getElementById("p_fabric_outro").style.display = "block";
    }
    
    // Preencher estoque do tamanho específico
    ["G1","G2","G3","G4","G5"].forEach(g => document.getElementById(`p_stock_${g.toLowerCase()}`).value = "0");
    document.getElementById(`p_stock_${p.size.toLowerCase()}`).value = p.stock || 0;
    
    // Mudar botão para modo de edição
    editingProductId = p.id;
    const btn = document.getElementById("btnAddProduct");
    btn.textContent = "Salvar Alterações";
    btn.className = "btn warn";
    
    toast("Modo edição","Produto carregado. Altere e clique em 'Salvar Alterações'.");
    
    // Scroll pro topo
    document.querySelector("#tab-produtos").scrollIntoView({ behavior: "smooth" });
  });

  document.getElementById("btnDeleteProduct").addEventListener("click", ()=>{
    if(!selectedProductId) return;
    const p = db.products.find(x=>x.id===selectedProductId);
    if(!p) return;

    const used = db.sales.some(s=>s.items.some(it=>it.productId===p.id));
    if(used) return toast("Bloqueado","Produto já apareceu em vendas. Para manter histórico, não excluo. Zere estoque e pare de usar.");

    db.products = db.products.filter(x=>x.id!==p.id);
    selectedProductId=null;
    saveDB("Produto excluído");
    toast("Excluído","Produto removido.");
    renderProducts();
    renderHome();
  });

  function renderProducts(){
    const q = document.getElementById("p_search").value.trim().toLowerCase();
    const sizeF = document.getElementById("p_filter_size").value;

    const list = db.products.filter(p=>{
      if(sizeF && p.size!==sizeF) return false;
      if(!q) return true;
      return (p.name||"").toLowerCase().includes(q)
        || (p.barcode||"").toLowerCase().includes(q)
        || (p.sku||"").toLowerCase().includes(q);
    });

    const tb = document.getElementById("prodTable");
    
    // Opções de categoria
    const catOptions = ['', 'Calça', 'Blusa', 'Short', 'Camisa', 'Vestido', 'Conjunto', 'Saia', 'Macaquinho'];
    
    // Opções de tecido
    const fabricOptions = ['', 'Viscose', 'Viscosinho', 'Linho', 'Crepe', 'Duna', 'Alfaiataria', 'Moletinho', 'Jeans'];
    
    tb.innerHTML = list.map(p=>{
      const sel = p.id===selectedProductId ? 'style="outline:2px solid rgba(230,0,126,.12);background:rgba(230,0,126,.04)"' : "";
      
      // SELECT de Categoria
      const catSelect = `<select data-edit="cat" data-pid="${escapeHtml(p.id)}" style="width:100%;padding:6px;font-size:13px">
        ${catOptions.map(opt => {
          const selected = opt === p.cat ? 'selected' : '';
          const display = opt === '' ? '(vazio)' : opt;
          return `<option value="${escapeHtml(opt)}" ${selected}>${escapeHtml(display)}</option>`;
        }).join('')}
        <option value="__OUTRO__" ${(!catOptions.includes(p.cat) && p.cat) ? 'selected' : ''}>Outro: ${escapeHtml(p.cat||'')}</option>
      </select>`;
      
      // SELECT de Tecido
      const fabricSelect = `<select data-edit="fabric" data-pid="${escapeHtml(p.id)}" style="width:100%;padding:6px;font-size:13px">
        ${fabricOptions.map(opt => {
          const selected = opt === p.fabric ? 'selected' : '';
          const display = opt === '' ? '(vazio)' : opt;
          return `<option value="${escapeHtml(opt)}" ${selected}>${escapeHtml(display)}</option>`;
        }).join('')}
        <option value="__OUTRO__" ${(!fabricOptions.includes(p.fabric) && p.fabric) ? 'selected' : ''}>Outro: ${escapeHtml(p.fabric||'')}</option>
      </select>`;
      
      return `
        <tr ${sel}>
          <td class="small" style="width:8%">${escapeHtml(p.barcode)}</td>
          <td style="width:30%">
            <div style="font-weight:500">${escapeHtml(p.name)}</div>
            <div class="muted small" style="margin-top:4px">${p.sku?("SKU: "+escapeHtml(p.sku)):""}</div>
          </td>
          <td style="width:15%">${catSelect}</td>
          <td style="width:13%">${fabricSelect}</td>
          <td style="width:5%;text-align:center">${escapeHtml(p.size||"")}</td>
          <td class="right" style="width:7%">${toNum(p.stock)}</td>
          <td class="right" style="width:8%">${fmtBRL(p.price)}</td>
          <td class="right" style="width:8%">${fmtBRL(p.cost)}</td>
          <td class="right" style="width:6%"><button class="btn small" data-select="${escapeHtml(p.id)}">Selecionar</button></td>
        </tr>
      `;
    }).join("");

    tb.querySelectorAll("button[data-select]").forEach(b=>{
      b.addEventListener("click", ()=>{
        selectedProductId = b.dataset.select;
        document.getElementById("btnDeleteProduct").disabled = !selectedProductId;
        document.getElementById("btnEditProduct").disabled = !selectedProductId;
        const p = db.products.find(x=>x.id===selectedProductId);
        document.getElementById("selectedProductPill").textContent = p ? `Selecionado: ${p.name} (${p.size})` : "Nenhum selecionado";
        renderProducts();
      });
    });

    tb.querySelectorAll("select[data-edit]").forEach(inp=>{
      inp.addEventListener("change", ()=>{
        const pid = inp.dataset.pid;
        const field = inp.dataset.edit;
        const p = db.products.find(x=>x.id===pid);
        if(!p) return;
        
        if(field==="cat"){
          if(inp.value === "__OUTRO__"){
            const custom = prompt("Digite a categoria:", p.cat || "");
            if(custom !== null) p.cat = custom.trim();
            renderProducts();
            saveDB("Produto editado");
            toast("Atualizado",`${p.name} - categoria ajustada.`);
            return;
          }
          p.cat = inp.value;
        }
        
        if(field==="fabric"){
          if(inp.value === "__OUTRO__"){
            const custom = prompt("Digite o tecido:", p.fabric || "");
            if(custom !== null) p.fabric = custom.trim();
            renderProducts();
            saveDB("Produto editado");
            toast("Atualizado",`${p.name} - tecido ajustado.`);
            return;
          }
          p.fabric = inp.value;
        }

        saveDB("Produto editado");
        toast("Atualizado",`${p.name} ajustado.`);
      });
    });

    document.getElementById("btnDeleteProduct").disabled = !selectedProductId;
    if(!selectedProductId) document.getElementById("selectedProductPill").textContent = "Nenhum selecionado";
  }

  /* =========================
     CLIENTES
  ========================= */
  document.getElementById("btnAddClient").addEventListener("click", ()=>{
    const name = document.getElementById("c_name").value.trim();
    if(!name) return toast("Faltou nome","Preencha o cliente.");
    const phone = document.getElementById("c_phone").value.trim();

    // Se está editando
    if(editingClientId){
      const c = db.clients.find(x=>x.id===editingClientId);
      if(!c) return toast("Erro","Cliente não encontrado.");
      
      c.name = name;
      c.phone = phone;
      c.cnpj = document.getElementById("c_cnpj").value.trim();
      c.cpf = document.getElementById("c_cpf").value.trim();
      c.city = document.getElementById("c_city").value.trim();
      c.note = document.getElementById("c_note").value.trim();
      c.trocaCount = Math.max(0, Math.floor(toNum(document.getElementById("c_trocas").value)));
      
      saveDB("Cliente atualizado");
      toast("Cliente atualizado","Dados salvos com sucesso.");
      editingClientId = null;
      document.getElementById("btnAddClient").textContent = "Salvar cliente";
      clearClientForm();
      renderClients();
      renderSaleClientSelect();
      renderHome();
      return;
    }

    // Se está criando novo
    const c = {
      id: uid("c"),
      name,
      phone,
      cnpj: document.getElementById("c_cnpj").value.trim(),
      cpf: document.getElementById("c_cpf").value.trim(),
      city: document.getElementById("c_city").value.trim(),
      note: document.getElementById("c_note").value.trim(),
      trocaCount: Math.max(0, Math.floor(toNum(document.getElementById("c_trocas").value)))
    };

    db.clients.unshift(c);
    saveDB("Cliente");
    toast("Cliente salvo","Cadastro concluído.");
    clearClientForm();
    renderClients();
    renderSaleClientSelect();
    renderHome();
  });

  document.getElementById("btnClearClient").addEventListener("click", clearClientForm);
  function clearClientForm(){
    ["c_name","c_phone","c_cnpj","c_cpf","c_city","c_note"].forEach(id=>document.getElementById(id).value="");
    document.getElementById("c_trocas").value="0";
    editingClientId = null;
    document.getElementById("btnAddClient").textContent = "Salvar cliente";
  }

  document.getElementById("c_search").addEventListener("input", renderClients);

  document.getElementById("btnEditClient").addEventListener("click", ()=>{
    if(!selectedClientId) return;
    const c = db.clients.find(x=>x.id===selectedClientId);
    if(!c) return toast("Erro","Cliente não encontrado.");
    
    // Carregar dados no formulário
    document.getElementById("c_name").value = c.name || "";
    document.getElementById("c_phone").value = c.phone || "";
    document.getElementById("c_cnpj").value = c.cnpj || "";
    document.getElementById("c_cpf").value = c.cpf || "";
    document.getElementById("c_city").value = c.city || "";
    document.getElementById("c_note").value = c.note || "";
    document.getElementById("c_trocas").value = c.trocaCount || "0";
    
    // Marcar que está editando
    editingClientId = c.id;
    document.getElementById("btnAddClient").textContent = "Atualizar cliente";
    
    // Scroll para o formulário
    document.querySelector("#tab-clientes .card").scrollIntoView({ behavior: 'smooth' });
    
    toast("Modo edição","Altere os dados e clique em 'Atualizar cliente'.");
  });

  function renderClients(){
    const q = document.getElementById("c_search").value.trim().toLowerCase();
    const list = db.clients.filter(c=>{
      if(!q) return true;
      return (c.name||"").toLowerCase().includes(q) || (c.phone||"").toLowerCase().includes(q);
    });

    const tb = document.getElementById("clientTable");
    tb.innerHTML = list.map(c=>{
      const sales = db.sales.filter(s=>s.clientId===c.id);
      const count = sales.length;
      const bruto = sales.reduce((a,s)=>a+toNum(s.totalBruto),0);
      const liquido = sales.reduce((a,s)=>a+toNum(s.netReceived||0),0);

      const sel = c.id===selectedClientId ? 'style="outline:2px solid rgba(230,0,126,.12);background:rgba(230,0,126,.04)"' : "";
      const doc = c.cnpj ? ("CNPJ " + c.cnpj) : (c.cpf ? ("CPF " + c.cpf) : "");
      const nameLine = doc ? `${c.name} (${doc})` : c.name;

      return `
        <tr data-cid="${escapeHtml(c.id)}" ${sel}>
          <td><div>${escapeHtml(nameLine)}</div><div class="muted small">${escapeHtml(c.city||"")}${c.note?(" | "+escapeHtml(c.note)):""}</div></td>
          <td>${escapeHtml(c.phone||"")}</td>
          <td class="right">${toNum(c.trocaCount||0)}</td>
          <td class="right">${count}</td>
          <td class="right">${fmtBRL(bruto)}</td>
          <td class="right">${fmtBRL(liquido)}</td>
        </tr>
      `;
    }).join("");

    tb.querySelectorAll("tr[data-cid]").forEach(tr=>{
      tr.addEventListener("click", ()=>{
        selectedClientId = tr.dataset.cid;
        const c = db.clients.find(x=>x.id===selectedClientId);
        document.getElementById("selectedClientPill").textContent = c ? `Selecionado: ${c.name}` : "Nenhum";
        document.getElementById("btnEditClient").disabled = !selectedClientId;
        renderClientHistory();
        renderClients();
      });
    });

    if(!selectedClientId){
      document.getElementById("selectedClientPill").textContent = "Nenhum";
      document.getElementById("btnEditClient").disabled = true;
      document.getElementById("clientHistory").textContent = "Selecione um cliente para ver as compras.";
    }
  }

  function renderClientHistory(){
    const c = db.clients.find(x=>x.id===selectedClientId);
    if(!c){ document.getElementById("clientHistory").textContent="Selecione um cliente para ver as compras."; return; }

    const sales = db.sales.filter(s=>s.clientId===c.id).slice(0,15);
    const trocaCount = toNum(c.trocaCount||0);

    let html = `<div class="small"><b>Trocas usadas:</b> ${trocaCount}</div>`;
    html += `<div class="sep"></div>`;

    if(!sales.length){
      html += "Sem compras registradas.";
      document.getElementById("clientHistory").innerHTML = html;
      return;
    }

    html += sales.map(s=>{
      const inst = s.installments ? (s.installments + "x") : "";
      const tag = `${s.channel || "Loja"} | ${s.kind || "Venda"} | ${s.pay}${inst?(" "+inst):""}`;
      return `<div class="small"><b>${new Date(s.date).toLocaleString("pt-BR")}</b>, ${escapeHtml(tag)}, bruto ${fmtBRL(s.totalBruto)}, líquido ${fmtBRL(s.netReceived||0)}</div>`;
    }).join("");

    document.getElementById("clientHistory").innerHTML = html;
  }

  /* =========================
     FINANCEIRO
  ========================= */
  
  // Inicializar categorias padrão se não existirem
  function initCategoriasFinanceiro(){
    if(!db.categorias || db.categorias.length === 0){
      db.categorias = [
        // Despesas
        {id: uid("cat"), nome: "Fixas - Aluguel", tipo: "despesa"},
        {id: uid("cat"), nome: "Fixas - Luz", tipo: "despesa"},
        {id: uid("cat"), nome: "Fixas - Água", tipo: "despesa"},
        {id: uid("cat"), nome: "Fixas - Internet", tipo: "despesa"},
        {id: uid("cat"), nome: "Fixas - Plano Saúde", tipo: "despesa"},
        {id: uid("cat"), nome: "Estoque - Fornecedores", tipo: "despesa"},
        {id: uid("cat"), nome: "Variáveis - Marketing", tipo: "despesa"},
        {id: uid("cat"), nome: "Variáveis - Manutenção", tipo: "despesa"},
        {id: uid("cat"), nome: "Pessoal - Salários", tipo: "despesa"},
        // Receitas
        {id: uid("cat"), nome: "Vendas", tipo: "receita"},
        {id: uid("cat"), nome: "Outras Receitas", tipo: "receita"}
      ];
      saveDB("Categorias inicializadas");
    }
  }

  // Funções auxiliares de data
  function addDays(date, days){
    const result = new Date(date);
    result.setDate(result.getDate() + days);
    return result;
  }

  function addWeeks(date, weeks){
    return addDays(date, weeks * 7);
  }

  function addMonths(date, months){
    const result = new Date(date);
    result.setMonth(result.getMonth() + months);
    return result;
  }

  function isAtrasada(vencimento, pago){
    if(pago) return false;
    const hoje = new Date();
    hoje.setHours(0,0,0,0);
    const venc = new Date(vencimento);
    venc.setHours(0,0,0,0);
    return venc < hoje;
  }

  function proximaVencer(vencimento, diasAntecedencia = 7){
    const hoje = new Date();
    hoje.setHours(0,0,0,0);
    const venc = new Date(vencimento);
    venc.setHours(0,0,0,0);
    const diff = Math.ceil((venc - hoje) / (1000 * 60 * 60 * 24));
    return diff >= 0 && diff <= diasAntecedencia;
  }

  // Renderizar categorias
  function renderCategorias(){
    const despesas = db.categorias.filter(c => c.tipo === "despesa");
    const receitas = db.categorias.filter(c => c.tipo === "receita");
    
    document.getElementById("fin_listaDespesas").innerHTML = despesas.map(c => 
      `<span class="pill">${escapeHtml(c.nome)} <button onclick="deleteCategoria('${c.id}')" style="background:none;border:none;color:inherit;cursor:pointer;margin-left:4px">×</button></span>`
    ).join("");
    
    document.getElementById("fin_listaReceitas").innerHTML = receitas.map(c => 
      `<span class="pill">${escapeHtml(c.nome)} <button onclick="deleteCategoria('${c.id}')" style="background:none;border:none;color:inherit;cursor:pointer;margin-left:4px">×</button></span>`
    ).join("");
    
    // Atualizar selects de categoria
    const despesasHtml = despesas.map(c => `<option value="${escapeHtml(c.id)}">${escapeHtml(c.nome)}</option>`).join("");
    document.getElementById("pagarCategoria").innerHTML = '<option value="">Selecione...</option>' + despesasHtml;
    document.getElementById("fin_filtroPagarCategoria").innerHTML = '<option value="">Todas</option>' + despesasHtml;
  }

  window.deleteCategoria = function(id){
    if(!confirm("Excluir esta categoria?")) return;
    db.categorias = db.categorias.filter(c => c.id !== id);
    saveDB("Categoria excluída");
    renderCategorias();
  };

  document.getElementById("btnAddCategoria").addEventListener("click", ()=>{
    const nome = document.getElementById("fin_novaCategoriaNome").value.trim();
    const tipo = document.getElementById("fin_novaCategoriaTipo").value;
    if(!nome) return toast("Faltou nome","Preencha o nome da categoria.");
    
    db.categorias.push({
      id: uid("cat"),
      nome,
      tipo
    });
    saveDB("Categoria adicionada");
    document.getElementById("fin_novaCategoriaNome").value = "";
    renderCategorias();
    toast("Sucesso!","Categoria adicionada.");
  });

  // CONTAS A PAGAR - Eventos
  document.getElementById("btnNovaPagar").addEventListener("click", ()=>{
    document.getElementById("modalPagarTitulo").textContent = "Nova Conta a Pagar";
    document.getElementById("editPagarId").value = "";
    ["pagarDescricao","pagarValor","pagarVencimento","pagarObs"].forEach(id => document.getElementById(id).value = "");
    document.getElementById("pagarCategoria").value = "";
    document.getElementById("pagarRecorrencia").value = "unica";
    document.getElementById("divPagarParcelas").style.display = "none";
    document.getElementById("modalContaPagar").style.display = "flex";
  });

  document.getElementById("pagarRecorrencia").addEventListener("change", ()=>{
    const rec = document.getElementById("pagarRecorrencia").value;
    document.getElementById("divPagarParcelas").style.display = rec !== "unica" ? "block" : "none";
  });

  document.getElementById("btnCancelarPagar").addEventListener("click", ()=>{
    document.getElementById("modalContaPagar").style.display = "none";
  });

  document.getElementById("btnSalvarPagar").addEventListener("click", ()=>{
    const descricao = document.getElementById("pagarDescricao").value.trim();
    const categoriaId = document.getElementById("pagarCategoria").value;
    const valor = Math.max(0, toNum(document.getElementById("pagarValor").value));
    const vencimento = document.getElementById("pagarVencimento").value;
    const recorrencia = document.getElementById("pagarRecorrencia").value;
    const parcelas = recorrencia !== "unica" ? Math.max(1, parseInt(document.getElementById("pagarParcelas").value) || 1) : 1;
    const obs = document.getElementById("pagarObs").value.trim();
    const editId = document.getElementById("editPagarId").value;

    if(!descricao) return toast("Faltou descrição","Preencha a descrição da conta.");
    if(!categoriaId) return toast("Faltou categoria","Selecione uma categoria.");
    if(valor <= 0) return toast("Valor inválido","Informe um valor maior que zero.");
    if(!vencimento) return toast("Faltou vencimento","Selecione a data de vencimento.");

    const categoria = db.categorias.find(c => c.id === categoriaId);

    if(editId){
      // Editar conta existente
      const conta = db.contas.find(c => c.id === editId);
      if(conta){
        conta.descricao = descricao;
        conta.categoriaId = categoriaId;
        conta.categoriaNome = categoria ? categoria.nome : "";
        conta.valor = valor;
        conta.proximoVencimento = vencimento;
        conta.obs = obs;
        saveDB("Conta a pagar atualizada");
        toast("Atualizado!","Conta a pagar atualizada.");
      }
    } else {
      // Nova conta
      const novaConta = {
        id: uid("fin"),
        tipo: "pagar",
        descricao,
        categoriaId,
        categoriaNome: categoria ? categoria.nome : "",
        valor,
        recorrencia,
        parcelas,
        parcelaAtual: 1,
        dataInicio: vencimento,
        proximoVencimento: vencimento,
        status: "ativo",
        obs
      };
      db.contas.push(novaConta);
      saveDB("Conta a pagar criada");
      toast("Sucesso!",`Conta criada${recorrencia !== "unica" ? ` com ${parcelas} parcelas` : ""}.`);
    }

    document.getElementById("modalContaPagar").style.display = "none";
    renderFinanceiro();
  });

  function renderContasPagar(){
    const statusFiltro = document.getElementById("fin_filtroPagarStatus").value;
    const catFiltro = document.getElementById("fin_filtroPagarCategoria").value;
    const busca = document.getElementById("fin_buscaPagar").value.trim().toLowerCase();

    let contas = db.contas.filter(c => c.tipo === "pagar");

    if(statusFiltro){
      contas = contas.filter(c => {
        if(statusFiltro === "pendente") return c.status === "ativo" && !isAtrasada(c.proximoVencimento, false);
        if(statusFiltro === "pago") return c.status === "concluido";
        if(statusFiltro === "atrasado") return c.status === "ativo" && isAtrasada(c.proximoVencimento, false);
        return true;
      });
    }

    if(catFiltro) contas = contas.filter(c => c.categoriaId === catFiltro);
    if(busca) contas = contas.filter(c => c.descricao.toLowerCase().includes(busca));

    const tb = document.getElementById("fin_tabelaPagar");
    if(!contas.length){
      tb.innerHTML = '<tr><td colspan="7" style="text-align:center;color:var(--muted);padding:24px">Nenhuma conta a pagar encontrada</td></tr>';
      return;
    }

    tb.innerHTML = contas.map(c => {
      const atrasada = isAtrasada(c.proximoVencimento, false);
      const statusText = c.status === "concluido" ? "Paga" : (atrasada ? "Atrasada" : "Pendente");
      const statusColor = c.status === "concluido" ? "#10b981" : (atrasada ? "#ef4444" : "#f59e0b");
      const recText = c.recorrencia === "unica" ? "Única" : (c.recorrencia === "semanal" ? `Semanal (${c.parcelaAtual}/${c.parcelas})` : `Mensal (${c.parcelaAtual}/${c.parcelas})`);

      return `
        <tr>
          <td>
            <div style="font-weight:500">${escapeHtml(c.descricao)}</div>
            ${c.obs ? `<div class="muted small">${escapeHtml(c.obs)}</div>` : ""}
          </td>
          <td>${escapeHtml(c.categoriaNome)}</td>
          <td class="right">${fmtBRL(c.valor)}</td>
          <td>${new Date(c.proximoVencimento).toLocaleDateString("pt-BR")}</td>
          <td><span class="pill" style="background:${statusColor};color:#fff">${statusText}</span></td>
          <td>${recText}</td>
          <td class="right">
            ${c.status === "ativo" ? `<button class="btn action success" onclick="pagarConta('${c.id}')">✓ Pagar</button>` : `<button class="btn action" onclick="cancelarPagamento('${c.id}', 'pagar')" style="color:#f59e0b">↺ Reabrir</button>`}
            <button class="btn action" onclick="editarContaPagar('${c.id}')">Editar</button>
            <button class="btn action danger" onclick="excluirConta('${c.id}')">× Excluir</button>
          </td>
        </tr>
      `;
    }).join("");
  }

  window.pagarConta = function(id){
    const conta = db.contas.find(c => c.id === id);
    if(!conta) return;

    // Registrar movimentação
    db.movimentacoes.push({
      id: uid("mov"),
      contaId: id,
      tipo: "pagar",
      descricao: `${conta.descricao} - Parcela ${conta.parcelaAtual}/${conta.parcelas}`,
      valor: conta.valor,
      data: new Date().toISOString().split("T")[0],
      dataPagamento: new Date().toISOString().split("T")[0],
      pago: true
    });

    // Atualizar conta
    if(conta.recorrencia === "unica" || conta.parcelaAtual >= conta.parcelas){
      conta.status = "concluido";
    } else {
      conta.parcelaAtual++;
      // Calcular próximo vencimento
      if(conta.recorrencia === "semanal"){
        conta.proximoVencimento = addWeeks(new Date(conta.proximoVencimento), 1).toISOString().split("T")[0];
      } else if(conta.recorrencia === "mensal"){
        conta.proximoVencimento = addMonths(new Date(conta.proximoVencimento), 1).toISOString().split("T")[0];
      }
    }

    saveDB("Conta paga");
    toast("Pago!","Pagamento registrado.");
    renderFinanceiro();
  };

  window.editarContaPagar = function(id){
    const conta = db.contas.find(c => c.id === id);
    if(!conta) return;

    document.getElementById("modalPagarTitulo").textContent = "Editar Conta a Pagar";
    document.getElementById("editPagarId").value = conta.id;
    document.getElementById("pagarDescricao").value = conta.descricao;
    document.getElementById("pagarCategoria").value = conta.categoriaId;
    document.getElementById("pagarValor").value = conta.valor;
    document.getElementById("pagarVencimento").value = conta.proximoVencimento;
    document.getElementById("pagarObs").value = conta.obs || "";
    document.getElementById("pagarRecorrencia").value = conta.recorrencia;
    
    if(conta.recorrencia !== "unica"){
      document.getElementById("divPagarParcelas").style.display = "block";
      document.getElementById("pagarParcelas").value = conta.parcelas;
    }

    document.getElementById("modalContaPagar").style.display = "flex";
  };

  window.excluirConta = function(id){
    if(!confirm("Excluir esta conta?")) return;
    db.contas = db.contas.filter(c => c.id !== id);
    db.movimentacoes = db.movimentacoes.filter(m => m.contaId !== id);
    saveDB("Conta excluída");
    toast("Excluído","Conta removida.");
    renderFinanceiro();
  };

  window.cancelarPagamento = function(id, tipo){
    const tipoTexto = tipo === "pagar" ? "pagamento" : "recebimento";
    if(!confirm(`Reabrir esta conta? O ${tipoTexto} será cancelado e a conta voltará como pendente.`)) return;
    
    const conta = db.contas.find(c => c.id === id);
    if(!conta) return;
    
    // Voltar status para ativo
    conta.status = "ativo";
    
    // Remover movimentação
    db.movimentacoes = db.movimentacoes.filter(m => m.contaId !== id);
    
    saveDB("Pagamento cancelado");
    toast("Reaberto!", "Conta voltou como pendente.");
    renderFinanceiro();
  };

  document.getElementById("fin_filtroPagarStatus").addEventListener("change", renderContasPagar);
  document.getElementById("fin_filtroPagarCategoria").addEventListener("change", renderContasPagar);
  document.getElementById("fin_buscaPagar").addEventListener("input", renderContasPagar);

  // Fechar modais ao clicar fora
  document.getElementById("modalContaPagar").addEventListener("click", (e)=>{
    if(e.target.id === "modalContaPagar") document.getElementById("modalContaPagar").style.display = "none";
  });
  
  document.getElementById("modalContaReceber").addEventListener("click", (e)=>{
    if(e.target.id === "modalContaReceber") document.getElementById("modalContaReceber").style.display = "none";
  });

  // CONTAS A RECEBER
  document.getElementById("btnNovaReceber").addEventListener("click", ()=>{
    document.getElementById("modalReceberTitulo").textContent = "Nova Conta a Receber";
    document.getElementById("editReceberId").value = "";
    ["receberDescricao","receberValor","receberVencimento","receberObs"].forEach(id => document.getElementById(id).value = "");
    document.getElementById("receberCliente").value = "";
    document.getElementById("receberForma").value = "PIX";
    
    // Preencher clientes
    const clientesHtml = '<option value="">Nenhum</option>' + db.clients.map(c => 
      `<option value="${escapeHtml(c.id)}">${escapeHtml(c.name)}</option>`
    ).join("");
    document.getElementById("receberCliente").innerHTML = clientesHtml;
    document.getElementById("fin_filtroReceberCliente").innerHTML = '<option value="">Todos</option>' + db.clients.map(c => 
      `<option value="${escapeHtml(c.id)}">${escapeHtml(c.name)}</option>`
    ).join("");

    document.getElementById("modalContaReceber").style.display = "flex";
  });

  document.getElementById("btnCancelarReceber").addEventListener("click", ()=>{
    document.getElementById("modalContaReceber").style.display = "none";
  });

  document.getElementById("btnSalvarReceber").addEventListener("click", ()=>{
    const descricao = document.getElementById("receberDescricao").value.trim();
    const clienteId = document.getElementById("receberCliente").value;
    const valor = Math.max(0, toNum(document.getElementById("receberValor").value));
    const vencimento = document.getElementById("receberVencimento").value;
    const forma = document.getElementById("receberForma").value;
    const obs = document.getElementById("receberObs").value.trim();
    const editId = document.getElementById("editReceberId").value;

    if(!descricao) return toast("Faltou descrição","Preencha a descrição.");
    if(valor <= 0) return toast("Valor inválido","Informe um valor maior que zero.");
    if(!vencimento) return toast("Faltou vencimento","Selecione a data de vencimento.");

    const cliente = clienteId ? db.clients.find(c => c.id === clienteId) : null;

    if(editId){
      const conta = db.contas.find(c => c.id === editId);
      if(conta){
        conta.descricao = descricao;
        conta.clienteId = clienteId;
        conta.clienteNome = cliente ? cliente.name : "";
        conta.valor = valor;
        conta.proximoVencimento = vencimento;
        conta.formaRecebimento = forma;
        conta.obs = obs;
        saveDB("Conta a receber atualizada");
        toast("Atualizado!","Conta a receber atualizada.");
      }
    } else {
      const novaConta = {
        id: uid("fin"),
        tipo: "receber",
        descricao,
        clienteId,
        clienteNome: cliente ? cliente.name : "",
        valor,
        proximoVencimento: vencimento,
        formaRecebimento: forma,
        status: "ativo",
        obs
      };
      db.contas.push(novaConta);
      saveDB("Conta a receber criada");
      toast("Sucesso!","Conta a receber criada.");
    }

    document.getElementById("modalContaReceber").style.display = "none";
    renderFinanceiro();
  });

  function renderContasReceber(){
    const statusFiltro = document.getElementById("fin_filtroReceberStatus").value;
    const clienteFiltro = document.getElementById("fin_filtroReceberCliente").value;
    const busca = document.getElementById("fin_buscaReceber").value.trim().toLowerCase();

    let contas = db.contas.filter(c => c.tipo === "receber");

    if(statusFiltro){
      contas = contas.filter(c => {
        if(statusFiltro === "pendente") return c.status === "ativo" && !isAtrasada(c.proximoVencimento, false);
        if(statusFiltro === "recebido") return c.status === "concluido";
        if(statusFiltro === "atrasado") return c.status === "ativo" && isAtrasada(c.proximoVencimento, false);
        return true;
      });
    }

    if(clienteFiltro) contas = contas.filter(c => c.clienteId === clienteFiltro);
    if(busca) contas = contas.filter(c => c.descricao.toLowerCase().includes(busca));

    const tb = document.getElementById("fin_tabelaReceber");
    if(!contas.length){
      tb.innerHTML = '<tr><td colspan="6" style="text-align:center;color:var(--muted);padding:24px">Nenhuma conta a receber encontrada</td></tr>';
      return;
    }

    tb.innerHTML = contas.map(c => {
      const atrasada = isAtrasada(c.proximoVencimento, false);
      const statusText = c.status === "concluido" ? "Recebido" : (atrasada ? "Atrasada" : "Pendente");
      const statusColor = c.status === "concluido" ? "#10b981" : (atrasada ? "#ef4444" : "#f59e0b");

      return `
        <tr>
          <td>
            <div style="font-weight:500">${escapeHtml(c.descricao)}</div>
            ${c.obs ? `<div class="muted small">${escapeHtml(c.obs)}</div>` : ""}
          </td>
          <td>${c.clienteNome ? escapeHtml(c.clienteNome) : "-"}</td>
          <td class="right">${fmtBRL(c.valor)}</td>
          <td>${new Date(c.proximoVencimento).toLocaleDateString("pt-BR")}</td>
          <td><span class="pill" style="background:${statusColor};color:#fff">${statusText}</span></td>
          <td class="right">
            ${c.status === "ativo" ? `<button class="btn action success" onclick="receberConta('${c.id}')">✓ Receber</button>` : `<button class="btn action" onclick="cancelarPagamento('${c.id}', 'receber')" style="color:#f59e0b">↺ Reabrir</button>`}
            <button class="btn action" onclick="editarContaReceber('${c.id}')">Editar</button>
            <button class="btn action danger" onclick="excluirConta('${c.id}')">× Excluir</button>
          </td>
        </tr>
      `;
    }).join("");
  }

  // FLUXO DE CAIXA - VISÃO MENSAL
  function popularMesesFluxo(){
    const select = document.getElementById("fin_fluxoMes");
    const hoje = new Date();
    const opcoes = [];
    
    // Calcular quantos meses desde Janeiro 2026 até Dezembro 2030
    const inicioAno = 2026;
    const inicioMes = 0; // Janeiro
    const fimAno = 2030;
    const fimMes = 11; // Dezembro
    
    for(let ano = inicioAno; ano <= fimAno; ano++){
      const mesInicio = (ano === inicioAno) ? inicioMes : 0;
      const mesFim = (ano === fimAno) ? fimMes : 11;
      
      for(let mes = mesInicio; mes <= mesFim; mes++){
        const mesNome = ['Janeiro','Fevereiro','Março','Abril','Maio','Junho','Julho','Agosto','Setembro','Outubro','Novembro','Dezembro'][mes];
        opcoes.push(`<option value="${ano}-${String(mes+1).padStart(2,'0')}">${mesNome} ${ano}</option>`);
      }
    }
    
    select.innerHTML = '<option value="">Todos os meses</option>' + opcoes.join("");
    
    // Selecionar mês atual se estiver no range
    const mesAtual = `${hoje.getFullYear()}-${String(hoje.getMonth()+1).padStart(2,'0')}`;
    if(hoje.getFullYear() >= inicioAno && hoje.getFullYear() <= fimAno){
      select.value = mesAtual;
    }
  }

  function renderFluxoCaixa(){
    const mesFiltro = document.getElementById("fin_fluxoMes").value;
    const tipoFiltro = document.getElementById("fin_fluxoTipo").value;
    const statusFiltro = document.getElementById("fin_fluxoStatus").value;

    let contas = [...db.contas];

    // Filtrar por mês/ano
    if(mesFiltro){
      contas = contas.filter(c => {
        const venc = c.proximoVencimento.substring(0, 7); // YYYY-MM
        return venc === mesFiltro;
      });
    }

    // Filtrar por tipo
    if(tipoFiltro) contas = contas.filter(c => c.tipo === tipoFiltro);

    // Filtrar por status
    if(statusFiltro){
      contas = contas.filter(c => {
        if(statusFiltro === "pendente") return c.status === "ativo" && !isAtrasada(c.proximoVencimento, false);
        if(statusFiltro === "pago") return c.status === "concluido";
        if(statusFiltro === "atrasado") return c.status === "ativo" && isAtrasada(c.proximoVencimento, false);
        return true;
      });
    }

    // Calcular totais
    const entradas = contas.filter(c => c.tipo === "receber").reduce((sum, c) => sum + toNum(c.valor), 0);
    const saidas = contas.filter(c => c.tipo === "pagar").reduce((sum, c) => sum + toNum(c.valor), 0);
    const saldo = entradas - saidas;

    document.getElementById("fin_fluxoEntradas").textContent = fmtBRL(entradas);
    document.getElementById("fin_fluxoSaidas").textContent = fmtBRL(saidas);
    document.getElementById("fin_fluxoSaldo").textContent = fmtBRL(saldo);
    document.getElementById("fin_fluxoSaldo").style.color = saldo >= 0 ? "#10b981" : "#ef4444";
    document.getElementById("fin_fluxoTotal").textContent = contas.length;

    // Ordenar por data
    contas.sort((a, b) => new Date(a.proximoVencimento) - new Date(b.proximoVencimento));

    // Renderizar tabela
    const tb = document.getElementById("fin_tabelaFluxo");
    if(!contas.length){
      tb.innerHTML = '<tr><td colspan="7" style="text-align:center;color:var(--muted);padding:24px">Nenhuma conta encontrada para o período selecionado</td></tr>';
      return;
    }

    tb.innerHTML = contas.map(c => {
      const atrasada = c.status === "ativo" && isAtrasada(c.proximoVencimento, false);
      const pago = c.status === "concluido";
      
      let statusText, statusColor;
      if(pago){
        statusText = c.tipo === "pagar" ? "Pago" : "Recebido";
        statusColor = "#64748b";
      } else if(atrasada){
        statusText = "Atrasada";
        statusColor = "#ef4444";
      } else {
        statusText = "Pendente";
        statusColor = "#64748b";
      }

      const tipoText = c.tipo === "pagar" ? "A Pagar" : "A Receber";
      const catCliente = c.tipo === "pagar" ? c.categoriaNome : (c.clienteNome || "-");

      return `
        <tr>
          <td>${new Date(c.proximoVencimento).toLocaleDateString("pt-BR")}</td>
          <td>
            <div style="font-weight:500">${escapeHtml(c.descricao)}</div>
            ${c.obs ? `<div class="muted small">${escapeHtml(c.obs)}</div>` : ""}
          </td>
          <td style="color:#64748b;font-weight:500;font-size:13px">${tipoText}</td>
          <td class="small">${escapeHtml(catCliente)}</td>
          <td class="right" style="font-weight:600;color:${c.tipo === 'pagar' ? '#ef4444' : '#10b981'}">${fmtBRL(c.valor)}</td>
          <td style="color:${statusColor};font-weight:500;font-size:13px">${statusText}</td>
        </tr>
      `;
    }).join("");
  }

  document.getElementById("fin_fluxoMes").addEventListener("change", renderFluxoCaixa);
  document.getElementById("fin_fluxoTipo").addEventListener("change", renderFluxoCaixa);
  document.getElementById("fin_fluxoStatus").addEventListener("change", renderFluxoCaixa);

  window.receberConta = function(id){
    const conta = db.contas.find(c => c.id === id);
    if(!conta) return;

    db.movimentacoes.push({
      id: uid("mov"),
      contaId: id,
      tipo: "receber",
      descricao: conta.descricao,
      valor: conta.valor,
      data: new Date().toISOString().split("T")[0],
      dataPagamento: new Date().toISOString().split("T")[0],
      pago: true
    });

    conta.status = "concluido";
    saveDB("Conta recebida");
    toast("Recebido!","Recebimento registrado.");
    renderFinanceiro();
  };

  window.editarContaReceber = function(id){
    const conta = db.contas.find(c => c.id === id);
    if(!conta) return;

    document.getElementById("modalReceberTitulo").textContent = "Editar Conta a Receber";
    document.getElementById("editReceberId").value = conta.id;
    document.getElementById("receberDescricao").value = conta.descricao;
    document.getElementById("receberCliente").value = conta.clienteId || "";
    document.getElementById("receberValor").value = conta.valor;
    document.getElementById("receberVencimento").value = conta.proximoVencimento;
    document.getElementById("receberForma").value = conta.formaRecebimento || "PIX";
    document.getElementById("receberObs").value = conta.obs || "";

    document.getElementById("modalContaReceber").style.display = "flex";
  };

  document.getElementById("fin_filtroReceberStatus").addEventListener("change", renderContasReceber);
  document.getElementById("fin_filtroReceberCliente").addEventListener("change", renderContasReceber);
  document.getElementById("fin_buscaReceber").addEventListener("input", renderContasReceber);

  // HISTÓRICO DE PAGAMENTOS
  function popularMesesHistorico(){
    const select = document.getElementById("fin_historicoMes");
    const opcoes = [];
    
    for(let ano = 2026; ano <= 2030; ano++){
      for(let mes = 0; mes <= 11; mes++){
        const mesNome = ['Janeiro','Fevereiro','Março','Abril','Maio','Junho','Julho','Agosto','Setembro','Outubro','Novembro','Dezembro'][mes];
        opcoes.push(`<option value="${ano}-${String(mes+1).padStart(2,'0')}">${mesNome} ${ano}</option>`);
      }
    }
    
    select.innerHTML = '<option value="">Todos os meses</option>' + opcoes.join("");
  }

  function renderHistorico(){
    const mesFiltro = document.getElementById("fin_historicoMes").value;
    const tipoFiltro = document.getElementById("fin_historicoTipo").value;
    const busca = document.getElementById("fin_historicoBusca").value.trim().toLowerCase();

    // Buscar contas concluídas E movimentações pagas
    let historico = [];
    
    // Adicionar contas que foram concluídas
    db.contas.filter(c => c.status === "concluido").forEach(c => {
      // Buscar movimentação relacionada
      const mov = db.movimentacoes.filter(m => m.contaId === c.id).sort((a,b) => new Date(b.dataPagamento) - new Date(a.dataPagamento))[0];
      if(mov){
        historico.push({
          id: c.id,
          tipo: c.tipo,
          descricao: c.descricao,
          valor: c.valor,
          dataPagamento: mov.dataPagamento,
          categoriaNome: c.categoriaNome,
          clienteNome: c.clienteNome
        });
      }
    });

    // Filtrar
    if(mesFiltro){
      historico = historico.filter(h => h.dataPagamento && h.dataPagamento.substring(0, 7) === mesFiltro);
    }
    if(tipoFiltro) historico = historico.filter(h => h.tipo === tipoFiltro);
    if(busca) historico = historico.filter(h => h.descricao.toLowerCase().includes(busca));

    // Ordenar por data (mais recente primeiro)
    historico.sort((a, b) => new Date(b.dataPagamento) - new Date(a.dataPagamento));

    const tb = document.getElementById("fin_tabelaHistorico");
    if(!historico.length){
      tb.innerHTML = '<tr><td colspan="6" style="text-align:center;color:var(--muted);padding:24px">Nenhum pagamento encontrado no histórico</td></tr>';
      return;
    }

    tb.innerHTML = historico.map(h => {
      const tipoText = h.tipo === "pagar" ? "Pago" : "Recebido";
      const catCliente = h.tipo === "pagar" ? h.categoriaNome : (h.clienteNome || "-");

      return `
        <tr>
          <td>${new Date(h.dataPagamento).toLocaleDateString("pt-BR")}</td>
          <td style="font-weight:500">${escapeHtml(h.descricao)}</td>
          <td style="color:#64748b;font-weight:500;font-size:13px">${tipoText}</td>
          <td class="small">${escapeHtml(catCliente)}</td>
          <td class="right" style="font-weight:600;color:${h.tipo === 'pagar' ? '#ef4444' : '#10b981'}">${fmtBRL(h.valor)}</td>
          <td class="right">
            <button class="btn action" onclick="cancelarPagamento('${h.id}', '${h.tipo}')" style="color:#f59e0b">↺ Cancelar</button>
          </td>
        </tr>
      `;
    }).join("");
  }

  document.getElementById("fin_historicoMes").addEventListener("change", renderHistorico);
  document.getElementById("fin_historicoTipo").addEventListener("change", renderHistorico);
  document.getElementById("fin_historicoBusca").addEventListener("input", renderHistorico);

  // DASHBOARD FINANCEIRO
  // Variáveis globais dos gráficos
  let chartCategorias = null;
  let chartEvolucao = null;

  function renderDashboardFinanceiro(){
    const hoje = new Date();
    const mesAtual = hoje.getMonth();
    const anoAtual = hoje.getFullYear();

    // Calcular movimentações do mês atual
    const movMes = db.movimentacoes.filter(m => {
      const data = new Date(m.data);
      return data.getMonth() === mesAtual && data.getFullYear() === anoAtual && m.pago;
    });

    const entradas = movMes.filter(m => m.tipo === "receber").reduce((sum, m) => sum + toNum(m.valor), 0);
    const saidas = movMes.filter(m => m.tipo === "pagar").reduce((sum, m) => sum + toNum(m.valor), 0);
    const saldo = entradas - saidas;

    // Atualizar KPIs
    document.getElementById("fin_dashEntradas").textContent = fmtBRL(entradas);
    document.getElementById("fin_dashSaidas").textContent = fmtBRL(saidas);
    document.getElementById("fin_dashSaldo").textContent = fmtBRL(saldo);
    
    const saldoBox = document.getElementById("fin_dashSaldoBox");
    if(saldo >= 0){
      saldoBox.style.background = "#f0fdf4";
      saldoBox.style.borderColor = "#86efac";
      document.getElementById("fin_dashSaldo").style.color = "#15803d";
    } else {
      saldoBox.style.background = "#fef2f2";
      saldoBox.style.borderColor = "#fca5a5";
      document.getElementById("fin_dashSaldo").style.color = "#b91c1c";
    }

    // GRÁFICO: Despesas por Categoria
    const despesasPorCategoria = {};
    movMes.filter(m => m.tipo === "pagar").forEach(m => {
      const conta = db.contas.find(c => c.id === m.contaId);
      if(conta){
        const cat = conta.categoriaNome || "Sem categoria";
        despesasPorCategoria[cat] = (despesasPorCategoria[cat] || 0) + toNum(m.valor);
      }
    });

    const catLabels = Object.keys(despesasPorCategoria);
    const catValues = Object.values(despesasPorCategoria);

    if(chartCategorias) chartCategorias.destroy();
    const ctxCat = document.getElementById("chartCategorias").getContext("2d");
    chartCategorias = new Chart(ctxCat, {
      type: "doughnut",
      data: {
        labels: catLabels.length ? catLabels : ["Nenhuma despesa"],
        datasets: [{
          data: catValues.length ? catValues : [1],
          backgroundColor: catLabels.length ? [
            "#ef4444", "#f59e0b", "#10b981", "#3b82f6", "#8b5cf6", 
            "#ec4899", "#14b8a6", "#f97316", "#06b6d4", "#84cc16"
          ] : ["#e5e7eb"]
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: true,
        plugins: {
          legend: { position: "bottom", labels: { boxWidth: 12, padding: 10, font: { size: 11 } } },
          tooltip: {
            callbacks: {
              label: (context) => {
                const label = context.label || "";
                const value = context.parsed || 0;
                const total = context.dataset.data.reduce((a, b) => a + b, 0);
                const percent = ((value / total) * 100).toFixed(1);
                return `${label}: R$ ${value.toFixed(2)} (${percent}%)`;
              }
            }
          }
        }
      }
    });

    // GRÁFICO: Evolução Mensal (últimos 6 meses)
    const meses = [];
    const entradasMes = [];
    const saidasMes = [];
    
    for(let i = 5; i >= 0; i--){
      const data = new Date(anoAtual, mesAtual - i, 1);
      const mes = data.getMonth();
      const ano = data.getFullYear();
      const mesNome = ['Jan','Fev','Mar','Abr','Mai','Jun','Jul','Ago','Set','Out','Nov','Dez'][mes];
      
      meses.push(`${mesNome}/${String(ano).slice(-2)}`);
      
      const movDoMes = db.movimentacoes.filter(m => {
        const dMov = new Date(m.data);
        return dMov.getMonth() === mes && dMov.getFullYear() === ano && m.pago;
      });
      
      entradasMes.push(movDoMes.filter(m => m.tipo === "receber").reduce((s, m) => s + toNum(m.valor), 0));
      saidasMes.push(movDoMes.filter(m => m.tipo === "pagar").reduce((s, m) => s + toNum(m.valor), 0));
    }

    if(chartEvolucao) chartEvolucao.destroy();
    const ctxEvo = document.getElementById("chartEvolucao").getContext("2d");
    chartEvolucao = new Chart(ctxEvo, {
      type: "bar",
      data: {
        labels: meses,
        datasets: [
          {
            label: "Entradas",
            data: entradasMes,
            backgroundColor: "#10b98166",
            borderColor: "#10b981",
            borderWidth: 2
          },
          {
            label: "Saídas",
            data: saidasMes,
            backgroundColor: "#ef444466",
            borderColor: "#ef4444",
            borderWidth: 2
          }
        ]
      },
      options: {
        responsive: true,
        maintainAspectRatio: true,
        scales: {
          y: {
            beginAtZero: true,
            ticks: {
              callback: (value) => 'R$ ' + value.toFixed(0)
            }
          }
        },
        plugins: {
          legend: { position: "top", labels: { boxWidth: 12, padding: 10, font: { size: 11 } } },
          tooltip: {
            callbacks: {
              label: (context) => `${context.dataset.label}: R$ ${context.parsed.y.toFixed(2)}`
            }
          }
        }
      }
    });
  }

  function renderFinanceiro(){
    initCategoriasFinanceiro();
    renderCategorias();
    popularMesesFluxo();
    popularMesesHistorico();
    renderDashboardFinanceiro();
    renderFluxoCaixa();
    renderContasPagar();
    renderContasReceber();
    renderHistorico();
  }

  /* =========================
     VENDEDORES
  ========================= */
  document.getElementById("btnAddVendedor").addEventListener("click", ()=>{
    const name = document.getElementById("v_name").value.trim();
    if(!name) return toast("Faltou nome","Preencha o nome do vendedor.");

    const v = {
      id: uid("v"),
      name,
      phone: document.getElementById("v_phone").value.trim(),
      note: document.getElementById("v_note").value.trim()
    };

    db.vendedores.unshift(v);
    saveDB("Vendedor");
    toast("Vendedor salvo","Cadastro concluído.");
    clearVendedorForm();
    renderVendedores();
    renderSaleVendedorSelect();
  });

  document.getElementById("btnClearVendedor").addEventListener("click", clearVendedorForm);
  function clearVendedorForm(){
    ["v_name","v_phone","v_note"].forEach(id=>document.getElementById(id).value="");
  }

  function renderVendedores(){
    const tb = document.getElementById("vendedorTable");
    tb.innerHTML = db.vendedores.map(v=>{
      return `
        <tr>
          <td>${escapeHtml(v.name)}</td>
          <td>${escapeHtml(v.phone||"")}</td>
          <td class="small muted">${escapeHtml(v.note||"")}</td>
          <td class="right"><button class="btn bad small" data-del="${escapeHtml(v.id)}">Excluir</button></td>
        </tr>
      `;
    }).join("");

    tb.querySelectorAll("button[data-del]").forEach(b=>{
      b.addEventListener("click", ()=>{
        const vid = b.dataset.del;
        const v = db.vendedores.find(x=>x.id===vid);
        if(!v) return;

        const used = db.sales.some(s=>s.vendedorId===vid);
        if(used) return toast("Bloqueado","Vendedor já apareceu em vendas. Não excluo para manter histórico.");

        db.vendedores = db.vendedores.filter(x=>x.id!==vid);
        saveDB("Vendedor excluído");
        toast("Excluído","Vendedor removido.");
        renderVendedores();
        renderSaleVendedorSelect();
      });
    });
  }

  /* =========================
     ESTOQUE (ENTRADA)
  ========================= */
  document.getElementById("s_barcode").addEventListener("input", ()=>{
    const code = document.getElementById("s_barcode").value.trim();
    const matches = findProductsByBarcode(code);
    const box = document.getElementById("stockPreview");
    
    if(!matches.length){
      box.textContent = code ? "Produto não encontrado. Cadastre em Produtos." : "Bipe um produto para ver detalhes.";
      return;
    }
    
    if(matches.length === 1){
      const p = matches[0];
      box.innerHTML = `<b>${escapeHtml(p.name)}</b> (${escapeHtml(p.size)})` +
        `<br><span class="muted small">${escapeHtml(p.cat||"")}${p.fabric?(" | "+escapeHtml(p.fabric)):""}</span>` +
        `<br><span class="muted small">Estoque: ${toNum(p.stock)} | Venda: ${fmtBRL(p.price)} | Custo: ${fmtBRL(p.cost)}</span>`;
    } else {
      box.innerHTML = `<b>Múltiplos produtos com esse barcode:</b><br>` + matches.map(p=>`${p.name} (${p.size})`).join(", ");
    }
  });

  document.getElementById("btnStockIn").addEventListener("click", ()=>{
    const code = document.getElementById("s_barcode").value.trim();
    const qty = Math.max(1, Math.floor(toNum(document.getElementById("s_qty").value)));
    const matches = findProductsByBarcode(code);
    
    if(!matches.length) return toast("Não encontrado","Cadastre o produto antes.");
    if(matches.length > 1) return toast("Múltiplos produtos","Esse barcode tem mais de um produto. Ajuste no cadastro.");

    const p = matches[0];
    const newCost = document.getElementById("s_cost").value.trim();
    if(newCost!=="") p.cost = Math.max(0, toNum(newCost));

    p.stock = Math.max(0, toNum(p.stock) + qty);

    db.stockMoves.unshift({
      id: uid("m"),
      date: nowISO(),
      type:"ENTRADA",
      barcode:p.barcode,
      productId:p.id,
      qty: qty,
      stockAfter:p.stock,
      note: document.getElementById("s_note").value.trim()
    });

    saveDB("Estoque");
    toast("Entrada lançada",`${p.name} +${qty} no estoque.`);
    document.getElementById("s_barcode").value="";
    document.getElementById("s_qty").value="1";
    document.getElementById("s_cost").value="";
    document.getElementById("s_note").value="";
    document.getElementById("stockPreview").textContent = "Bipe um produto para ver detalhes.";
    renderStock();
    renderHome();
  });

  document.getElementById("btnClearStock").addEventListener("click", ()=>{
    ["s_barcode","s_cost","s_note"].forEach(id=>document.getElementById(id).value="");
    document.getElementById("s_qty").value="1";
    document.getElementById("stockPreview").textContent="Bipe um produto para ver detalhes.";
  });

  document.getElementById("btnStockManual").addEventListener("click", ()=>{
    openStockManualModal();
  });

  function openStockManualModal(){
    const modal = document.getElementById("modalStockManual");
    document.getElementById("stock_manual_search").value = "";
    renderStockManualProductTable("");
    modal.classList.remove("hide");
  }

  function closeStockManualModal(){
    document.getElementById("modalStockManual").classList.add("hide");
  }

  document.getElementById("btnCancelStockManual").addEventListener("click", closeStockManualModal);

  document.getElementById("stock_manual_search").addEventListener("input", ()=>{
    const q = document.getElementById("stock_manual_search").value.trim();
    renderStockManualProductTable(q);
  });

  function renderStockManualProductTable(query){
    const q = query.toLowerCase();
    const list = db.products.filter(p=>{
      if(!q) return true;
      return (p.name||"").toLowerCase().includes(q) || (p.barcode||"").toLowerCase().includes(q) || (p.cat||"").toLowerCase().includes(q) || (p.fabric||"").toLowerCase().includes(q) || (p.sku||"").toLowerCase().includes(q);
    }).slice(0,50);

    const tb = document.getElementById("stockManualProductTable");
    tb.innerHTML = list.map(p=>{
      return `
        <tr>
          <td>
            <div>${escapeHtml(p.name)}</div>
            <div class="muted small">${escapeHtml(p.cat||"")}${p.fabric?(" | "+escapeHtml(p.fabric)):""}</div>
          </td>
          <td>${escapeHtml(p.size||"")}</td>
          <td class="right">${toNum(p.stock)}</td>
          <td class="right">${fmtBRL(p.cost)}</td>
          <td class="right"><button class="btn ok small" data-entry="${escapeHtml(p.id)}">Dar entrada</button></td>
        </tr>
      `;
    }).join("");

    tb.querySelectorAll("button[data-entry]").forEach(b=>{
      b.addEventListener("click", ()=>{
        const p = db.products.find(x=>x.id===b.dataset.entry);
        if(p){
          openStockEntryModal(p);
        }
      });
    });
  }

  function openStockEntryModal(product){
    currentStockEntryProductId = product.id;
    const modal = document.getElementById("modalStockEntry");
    
    const info = document.getElementById("stockEntryInfo");
    info.innerHTML = `
      <b>Produto:</b> ${escapeHtml(product.name)}<br>
      <b>Grade:</b> ${escapeHtml(product.size||"")}<br>
      <b>Estoque atual:</b> ${toNum(product.stock)}<br>
      <b>Custo atual:</b> ${fmtBRL(product.cost)}
    `;

    document.getElementById("stock_entry_qty").value = "1";
    document.getElementById("stock_entry_cost").value = "";
    document.getElementById("stock_entry_note").value = "";

    closeStockManualModal();
    modal.classList.remove("hide");
  }

  function closeStockEntryModal(){
    document.getElementById("modalStockEntry").classList.add("hide");
    currentStockEntryProductId = null;
  }

  document.getElementById("btnCancelStockEntry").addEventListener("click", closeStockEntryModal);

  document.getElementById("btnConfirmStockEntry").addEventListener("click", ()=>{
    const p = db.products.find(x=>x.id===currentStockEntryProductId);
    if(!p) return toast("Erro","Produto não encontrado.");

    const qty = Math.max(1, Math.floor(toNum(document.getElementById("stock_entry_qty").value)));
    const newCost = document.getElementById("stock_entry_cost").value.trim();
    
    if(newCost!=="") p.cost = Math.max(0, toNum(newCost));
    p.stock = Math.max(0, toNum(p.stock) + qty);

    db.stockMoves.unshift({
      id: uid("m"),
      date: nowISO(),
      type:"ENTRADA",
      barcode:p.barcode,
      productId:p.id,
      qty: qty,
      stockAfter:p.stock,
      note: document.getElementById("stock_entry_note").value.trim()
    });

    saveDB("Estoque");
    toast("Entrada lançada",`${p.name} +${qty} no estoque.`);
    
    closeStockEntryModal();
    renderStock();
    renderHome();
  });

  function renderStock(){
    const tb = document.getElementById("stockMoves");
    const list = db.stockMoves.slice(0,140);
    tb.innerHTML = list.map(m=>{
      const p = db.products.find(x=>x.id===m.productId);
      return `
        <tr>
          <td class="small">${new Date(m.date).toLocaleString("pt-BR")}</td>
          <td>${escapeHtml(m.type)}</td>
          <td class="small">${escapeHtml(m.barcode)}</td>
          <td>${escapeHtml(p?.name||"")}</td>
          <td class="right">${toNum(m.qty)}</td>
          <td class="right">${toNum(m.stockAfter)}</td>
        </tr>
      `;
    }).join("");
    renderStockReport();
  }

  /* =========================
     RELATÓRIO DE ESTOQUE (VISÃO GERAL)
  ========================= */
  function renderStockReport(){
    const qEl = document.getElementById("st_q");
    const catEl = document.getElementById("st_cat");
    const sizeEl = document.getElementById("st_size");
    const body = document.getElementById("stockReportBody");
    if(!qEl || !catEl || !sizeEl || !body) return;

    // popular categorias
    const cats = Array.from(new Set(db.products.map(p=>String(p.cat||"").trim()).filter(Boolean)))
      .sort((a,b)=>a.localeCompare(b,"pt-BR",{sensitivity:"base"}));
    const current = catEl.value;
    catEl.innerHTML = `<option value="">Todas</option>` + cats.map(c=>`<option value="${escapeHtml(c)}">${escapeHtml(c)}</option>`).join("");
    if(cats.includes(current)) catEl.value = current;

    const q = qEl.value.trim().toLowerCase();
    const cat = catEl.value || "";
    const size = sizeEl.value || "";

    // agrupar por modelo (nome + categoria + tecido)
    const map = new Map();
    for(const p of db.products){
      const name = String(p.name||"").trim();
      const gcat = String(p.cat||"").trim();
      const gfabric = String(p.fabric||"").trim();
      const key = `${name}||${gcat}||${gfabric}`;

      if(!map.has(key)){
        map.set(key, {
          name, cat:gcat, fabric:gfabric,
          sizes:{G1:0,G2:0,G3:0,G4:0,G5:0},
          total:0,
          costMin: null, costMax: null,
          priceMin: null, priceMax: null,
          costTotal:0, sellTotal:0,
          barcodes:[]
        });
      }
      const g = map.get(key);
      const sz = String(p.size||"").trim();
      const st = toNum(p.stock);
      if(g.sizes[sz] == null) g.sizes[sz] = 0;
      g.sizes[sz] += st;

      const c = toNum(p.cost);
      const pr = toNum(p.price);
      if(g.costMin === null){ g.costMin = c; g.costMax = c; }
      else { g.costMin = Math.min(g.costMin, c); g.costMax = Math.max(g.costMax, c); }
      if(g.priceMin === null){ g.priceMin = pr; g.priceMax = pr; }
      else { g.priceMin = Math.min(g.priceMin, pr); g.priceMax = Math.max(g.priceMax, pr); }

      g.costTotal += st * c;
      g.sellTotal += st * pr;
      g.barcodes.push(String(p.barcode||""));
    }

    let groups = Array.from(map.values()).map(g=>{
      g.total = Object.values(g.sizes).reduce((a,b)=>a+toNum(b),0);
      return g;
    });

    // filtros
    groups = groups.filter(g=>{
      if(q){
        const inName = (g.name||"").toLowerCase().includes(q);
        const inCat = (g.cat||"").toLowerCase().includes(q);
        const inFab = (g.fabric||"").toLowerCase().includes(q);
        const inBar = g.barcodes.some(b=>String(b||"").toLowerCase().includes(q));
        if(!(inName || inCat || inFab || inBar)) return false;
      }
      if(cat && g.cat !== cat) return false;
      if(size && toNum(g.sizes[size]) <= 0) return false;
      return true;
    });

    groups.sort((a,b)=> (b.total - a.total) || (a.name||"").localeCompare(b.name||"","pt-BR",{sensitivity:"base"}));

    // KPIs
    const totQty = groups.reduce((s,g)=>s+toNum(g.total),0);
    const totCost = groups.reduce((s,g)=>s+toNum(g.costTotal),0);
    const totSell = groups.reduce((s,g)=>s+toNum(g.sellTotal),0);

    const kQty = document.getElementById("st_kpi_qty");
    const kCost = document.getElementById("st_kpi_cost");
    const kSell = document.getElementById("st_kpi_sell");
    if(kQty) kQty.textContent = String(totQty);
    if(kCost) kCost.textContent = fmtBRL(totCost);
    if(kSell) kSell.textContent = fmtBRL(totSell);

    const hint = document.getElementById("stockReportHint");
    if(hint) hint.textContent = `Mostrando ${groups.length} modelo(s). (Filtro por grade mostra somente modelos com estoque naquela grade.)`;

    // tabela
    body.innerHTML = groups.map(g=>{
      const cu = (g.costMin==null) ? "" : (g.costMin===g.costMax ? fmtBRL(g.costMin) : `${fmtBRL(g.costMin)} a ${fmtBRL(g.costMax)}`);
      const vu = (g.priceMin==null) ? "" : (g.priceMin===g.priceMax ? fmtBRL(g.priceMin) : `${fmtBRL(g.priceMin)} a ${fmtBRL(g.priceMax)}`);
      return `
        <tr>
          <td>${escapeHtml(g.name)}</td>
          <td class="small">${escapeHtml(g.cat||"")}</td>
          <td class="small">${escapeHtml(g.fabric||"")}</td>
          <td class="right">${toNum(g.sizes.G1||0)}</td>
          <td class="right">${toNum(g.sizes.G2||0)}</td>
          <td class="right">${toNum(g.sizes.G3||0)}</td>
          <td class="right">${toNum(g.sizes.G4||0)}</td>
          <td class="right">${toNum(g.sizes.G5||0)}</td>
          <td class="right"><b>${toNum(g.total)}</b></td>
          <td class="right">${cu}</td>
          <td class="right">${vu}</td>
          <td class="right">${fmtBRL(g.costTotal)}</td>
          <td class="right">${fmtBRL(g.sellTotal)}</td>
        </tr>
      `;
    }).join("");
  }

  // listeners de filtro (estoque geral)
  (function bindStockReportFilters(){
    const qEl = document.getElementById("st_q");
    const catEl = document.getElementById("st_cat");
    const sizeEl = document.getElementById("st_size");
    if(qEl) qEl.addEventListener("input", renderStockReport);
    if(catEl) catEl.addEventListener("change", renderStockReport);
    if(sizeEl) sizeEl.addEventListener("change", renderStockReport);
  })();


  /* =========================
     VENDA (PDV)
  ========================= */
  function renderSaleClientSelect(){
    const sel = document.getElementById("sale_client");
    const currentValue = sel.value;
    const opts = ['<option value="">Cliente não informado</option>']
      .concat(db.clients.map(c=>{
        const doc = c.cnpj ? ("CNPJ " + c.cnpj) : (c.cpf ? ("CPF " + c.cpf) : "");
        const label = doc ? `${c.name} (${doc})` : c.name;
        const trocas = toNum(c.trocaCount||0);
        const extra = trocas ? ` | Trocas: ${trocas}` : "";
        return `<option value="${escapeHtml(c.id)}">${escapeHtml(label)}${c.phone?(" | "+escapeHtml(c.phone)):""}${escapeHtml(extra)}</option>`;
      }));
    sel.innerHTML = opts.join("");
    sel.value = currentValue;
  }

  function renderSaleVendedorSelect(){
    const sel = document.getElementById("sale_vendedor");
    const currentValue = sel.value;
    const opts = ['<option value="">Vendedor não informado</option>']
      .concat(db.vendedores.map(v=>{
        return `<option value="${escapeHtml(v.id)}">${escapeHtml(v.name)}</option>`;
      }));
    sel.innerHTML = opts.join("");
    sel.value = currentValue;
  }

  function syncInstallmentsUI(){
    const pay = document.getElementById("sale_pay").value;
    const wrap = document.getElementById("instWrap");
    wrap.classList.toggle("hide", pay !== "CartaoParcelado");
  }

  function syncTrocaWarning(){
    const cid = document.getElementById("sale_client").value || "";
    const kind = document.getElementById("sale_kind").value || "Venda";
    const warn = document.getElementById("trocaWarn");
    if(!cid || kind !== "Troca"){ warn.classList.add("hide"); return; }
    const c = findClientById(cid);
    const trocaCount = toNum(c?.trocaCount||0);
    if(trocaCount >= 1) warn.classList.remove("hide");
    else warn.classList.add("hide");
  }

  document.getElementById("sale_pay").addEventListener("change", ()=>{
    syncInstallmentsUI();
    renderSaleTotals();
  });

  document.getElementById("sale_inst").addEventListener("change", ()=>{
    renderSaleTotals();
  });

  document.getElementById("sale_kind").addEventListener("change", ()=>{
    syncTrocaWarning();
  });

  document.getElementById("sale_client").addEventListener("change", ()=>{
    syncTrocaWarning();
  });

  document.getElementById("sale_barcode").addEventListener("keydown", (e)=>{
    if(e.key==="Enter"){
      e.preventDefault();
      const code = document.getElementById("sale_barcode").value.trim();
      handleBarcodeInput(code);
      document.getElementById("sale_barcode").value="";
    }
  });

  function handleBarcodeInput(code){
    if(!code) return;
    const matches = findProductsByBarcode(code);
    
    if(!matches.length) return toast("Produto não encontrado","Cadastre em Produtos.");
    
    if(matches.length === 1){
      addProductToSale(matches[0]);
    } else {
      pendingBarcodeForGrade = code;
      openGradeModal(matches);
    }
  }

  function openGradeModal(products){
    const modal = document.getElementById("modalGrade");
    const info = document.getElementById("modalGradeInfo");
    info.innerHTML = `<b>${escapeHtml(products[0].name)}</b><br>Escolha a grade:`;
    
    modal.querySelectorAll("button[data-grade]").forEach(btn=>{
      const grade = btn.dataset.grade;
      const p = products.find(x=>x.size===grade);
      btn.disabled = !p;
      btn.onclick = ()=>{
        if(p) addProductToSale(p);
        closeGradeModal();
      };
    });
    
    modal.classList.remove("hide");
  }

  function closeGradeModal(){
    document.getElementById("modalGrade").classList.add("hide");
    pendingBarcodeForGrade = null;
  }

  document.getElementById("btnCancelGrade").addEventListener("click", closeGradeModal);

  document.getElementById("btnManualAdd").addEventListener("click", ()=>{
    openManualAddModal();
  });

  function openManualAddModal(){
    const modal = document.getElementById("modalManual");
    document.getElementById("manual_search").value = "";
    renderManualProductTable("");
    modal.classList.remove("hide");
  }

  function closeManualAddModal(){
    document.getElementById("modalManual").classList.add("hide");
  }

  document.getElementById("btnCancelManual").addEventListener("click", closeManualAddModal);

  document.getElementById("manual_search").addEventListener("input", ()=>{
    const q = document.getElementById("manual_search").value.trim();
    renderManualProductTable(q);
  });

  function renderManualProductTable(query){
    const q = query.toLowerCase();
    const list = db.products.filter(p=>{
      if(!q) return true;
      return (p.name||"").toLowerCase().includes(q) || (p.barcode||"").toLowerCase().includes(q) || (p.cat||"").toLowerCase().includes(q) || (p.fabric||"").toLowerCase().includes(q) || (p.sku||"").toLowerCase().includes(q);
    }).slice(0,50);

    const tb = document.getElementById("manualProductTable");
    tb.innerHTML = list.map(p=>{
      return `
        <tr>
          <td>
            <div>${escapeHtml(p.name)}</div>
            <div class="muted small">${escapeHtml(p.cat||"")}${p.fabric?(" | "+escapeHtml(p.fabric)):""}</div>
          </td>
          <td class="small">${escapeHtml(p.barcode)}</td>
          <td>${escapeHtml(p.size||"")}</td>
          <td class="right">${toNum(p.stock)}</td>
          <td class="right">${fmtBRL(p.price)}</td>
          <td class="right"><button class="btn ok small" data-add="${escapeHtml(p.id)}">Adicionar</button></td>
        </tr>
      `;
    }).join("");

    tb.querySelectorAll("button[data-add]").forEach(b=>{
      b.addEventListener("click", ()=>{
        const p = db.products.find(x=>x.id===b.dataset.add);
        if(p){
          addProductToSale(p);
          closeManualAddModal();
        }
      });
    });
  }

  function addProductToSale(p){
    if(toNum(p.stock)<=0) return toast("Sem estoque",`${p.name} está zerado.`);

    const existing = currentSale.items.find(it=>it.productId===p.id);
    if(existing){
      if(existing.qty + 1 > toNum(p.stock)) return toast("Estoque insuficiente","Já bateu o limite deste item.");
      existing.qty += 1;
    }else{
      currentSale.items.push({ productId:p.id, name:p.name, cat:(p.cat||""), fabric:(p.fabric||""), size:p.size, price:toNum(p.price), cost:toNum(p.cost), qty:1, barcode:p.barcode });
    }
    renderSale();
    toast("Adicionado", `${p.name} (${p.size})`);
  }

  document.getElementById("sale_discount").addEventListener("input", renderSaleTotals);

  document.getElementById("btnClearSale").addEventListener("click", ()=>{
    currentSale = { items:[], finalizedSaleId:null };
    document.getElementById("overrideTroca").checked = false;
    toast("Venda limpa","Pronto para nova venda.");
    renderSale();
  });

  function saleTotals(sale){
    let sub = 0, cost = 0;
    for(const it of sale.items){
      sub += (toNum(it.price) * toNum(it.qty));
      cost += (toNum(it.cost) * toNum(it.qty));
    }

    const disc = toNum(document.getElementById("sale_discount")?.value || 0);
    const totalBruto = Math.max(0, sub - disc);

    const pay = document.getElementById("sale_pay")?.value || "PIX";
    const inst = document.getElementById("sale_inst")?.value || "2";

    const fee = calcCardFee(totalBruto, pay, inst);
    const feeValue = Math.max(0, toNum(fee.feeValue));
    const net = Math.max(0, toNum(fee.net));

    const profit = net - cost;

    return { sub, disc, totalBruto, cost, profit, feePct: fee.pct, feeValue, net };
  }

  function renderSaleTotals(){
    const t = saleTotals(currentSale);
    document.getElementById("sale_sub").textContent = fmtBRL(t.sub);
    document.getElementById("sale_disc").textContent = fmtBRL(t.disc);
    document.getElementById("sale_total").textContent = fmtBRL(t.totalBruto);
    document.getElementById("sale_fee").textContent = fmtBRL(t.feeValue);
    document.getElementById("sale_net").textContent = fmtBRL(t.net);
    document.getElementById("sale_profit").textContent = fmtBRL(t.profit);
  }

  function renderSale(){
    renderSaleClientSelect();
    renderSaleVendedorSelect();
    syncInstallmentsUI();
    syncTrocaWarning();
    renderSalesTable();

    const tb = document.getElementById("saleItems");
    tb.innerHTML = currentSale.items.map((it,idx)=>{
      const total = toNum(it.price)*toNum(it.qty);
      return `
        <tr>
          <td>${escapeHtml(it.name)}</td>
          <td>${escapeHtml(it.size||"")}</td>
          <td class="right">
            <input type="number" min="1" step="1" value="${toNum(it.qty)}" data-qty="${idx}" style="max-width:90px;text-align:right" />
          </td>
          <td class="right">${fmtBRL(it.price)}</td>
          <td class="right">${fmtBRL(total)}</td>
          <td class="right"><button class="btn bad small" data-rm="${idx}">Remover</button></td>
        </tr>
      `;
    }).join("");

    tb.querySelectorAll("button[data-rm]").forEach(b=>{
      b.addEventListener("click", ()=>{
        const i = Number(b.dataset.rm);
        currentSale.items.splice(i,1);
        renderSale();
      });
    });

    tb.querySelectorAll("input[data-qty]").forEach(inp=>{
      inp.addEventListener("change", ()=>{
        const i = Number(inp.dataset.qty);
        const it = currentSale.items[i];
        if(!it) return;
        const p = db.products.find(x=>x.id===it.productId);
        const max = p ? toNum(p.stock) : 999999;
        let v = Math.max(1, Math.floor(toNum(inp.value)));
        if(v>max) v = max;
        it.qty = v;
        renderSale();
      });
    });

    renderSaleTotals();
  }

  document.getElementById("btnFinalize").addEventListener("click", ()=>{
    if(!currentSale.items.length) return toast("Sem itens","Bipe pelo menos 1 produto.");

    const cid = document.getElementById("sale_client").value || "";
    const vid = document.getElementById("sale_vendedor").value || "";
    const kind = document.getElementById("sale_kind").value || "Venda";
    const override = document.getElementById("overrideTroca").checked;
    const c = cid ? findClientById(cid) : null;

    if(kind === "Troca" && cid && settings.blockSecondSwap && !override){
      const trocaCount = toNum(c?.trocaCount||0);
      if(trocaCount >= 1){
        return toast("Bloqueado","Este cliente já usou troca. Marque 'Liberar 2ª troca' apenas se for exceção.");
      }
    }

    for(const it of currentSale.items){
      const p = db.products.find(x=>x.id===it.productId);
      if(!p) return toast("Erro","Produto não encontrado no cadastro.");
      if(toNum(p.stock) < toNum(it.qty)) return toast("Estoque insuficiente",`${p.name} não tem quantidade suficiente.`);
    }

    for(const it of currentSale.items){
      const p = db.products.find(x=>x.id===it.productId);
      p.stock = Math.max(0, toNum(p.stock) - toNum(it.qty));
      db.stockMoves.unshift({ id:uid("m"), date: nowISO(), type:"SAIDA", barcode:p.barcode, productId:p.id, qty: -toNum(it.qty), stockAfter:p.stock, note:"Venda" });
    }

    const totals = saleTotals(currentSale);
    const pay = document.getElementById("sale_pay").value || "";
    const inst = document.getElementById("sale_inst").value || "";
    const channel = document.getElementById("sale_channel").value || "Loja";

    const sale = {
      id: uid("s"),
      date: nowISO(),
      clientId: cid,
      vendedorId: vid,
      channel,
      kind,
      pay,
      installments: pay === "CartaoParcelado" ? Number(inst) : 0,
      discount: totals.disc,
      subtotal: totals.sub,
      totalBruto: totals.totalBruto,
      costTotal: totals.cost,
      feePct: totals.feePct,
      feeValue: totals.feeValue,
      netReceived: totals.net,
      profit: totals.profit,
      note: document.getElementById("sale_note").value.trim(),
      items: currentSale.items.map(it=>({ ...it })),
      payments: [],
      paymentStatus: "Aberto"
    };

    if(kind === "Troca" && cid && c){
      c.trocaCount = toNum(c.trocaCount||0) + 1;
    }

    db.sales.unshift(sale);
    saveDB("Venda");
    
    const saleId = sale.id;
    
    toast("Finalizado","Venda #" + saleId.slice(-6).toUpperCase() + " salva com sucesso!");
    
    // Limpar tudo automaticamente após 1.5 segundos
    setTimeout(()=>{
      currentSale = { items:[], finalizedSaleId:null };
      document.getElementById("sale_client").value = "";
      document.getElementById("sale_vendedor").value = "";
      document.getElementById("sale_channel").value = "Loja";
      document.getElementById("sale_kind").value = "Venda";
      document.getElementById("sale_pay").value = "PIX";
      document.getElementById("sale_discount").value = "0";
      document.getElementById("sale_note").value = "";
      document.getElementById("overrideTroca").checked = false;
      renderSale();
      renderSalesTable();
      toast("Pronto!","Sistema limpo para a próxima venda.");
    }, 1500);
    
    renderSale();
    renderHome();
  });

  document.getElementById("btnClearSale").addEventListener("click", ()=>{
    currentSale = { items:[], finalizedSaleId:null };
    document.getElementById("sale_client").value = "";
    document.getElementById("sale_vendedor").value = "";
    document.getElementById("sale_pay").value = "PIX";
    document.getElementById("sale_channel").value = "Loja";
    document.getElementById("sale_kind").value = "Venda";
    document.getElementById("sale_discount").value = "0";
    document.getElementById("sale_note").value = "";
    document.getElementById("overrideTroca").checked = false;
    toast("Venda limpa","Pronto para nova venda.");
    renderSale();
  });

  function sendWhatsApp(sale, isOrcamento = false){
    let saleData, c, v, inst, phone;
    
    if(isOrcamento){
      const totals = saleTotals(currentSale);
      const cid = document.getElementById("sale_client").value || "";
      const vid = document.getElementById("sale_vendedor").value || "";
      const pay = document.getElementById("sale_pay").value || "";
      const channel = document.getElementById("sale_channel").value || "Loja";
      const kind = document.getElementById("sale_kind").value || "Venda";
      
      c = cid ? findClientById(cid) : null;
      v = vid ? findVendedorById(vid) : null;
      inst = pay === "CartaoParcelado" ? (document.getElementById("sale_inst").value + "x") : "";
      phone = c?.phone || "";
      
      saleData = {
        date: new Date().toISOString(),
        channel,
        kind,
        pay,
        items: currentSale.items,
        note: document.getElementById("sale_note").value.trim(),
        subtotal: totals.sub,
        discount: totals.disc,
        totalBruto: totals.totalBruto
      };
    } else {
      saleData = sale;
      c = sale.clientId ? findClientById(sale.clientId) : null;
      v = sale.vendedorId ? findVendedorById(sale.vendedorId) : null;
      inst = sale.installments ? (sale.installments + "x") : "";
      phone = c?.phone || "";
    }

    if(!phone) return toast("Sem WhatsApp","Cliente não tem telefone cadastrado.");

    // Limpar telefone (remover caracteres especiais)
    const cleanPhone = phone.replace(/\D/g, "");
    if(cleanPhone.length < 10) return toast("Telefone inválido","Telefone precisa ter DDD + número.");

    // Formatar mensagem
    const tipo = isOrcamento ? "ORÇAMENTO" : "RECIBO DE VENDA";
    const pedido = sale?.id?.slice(-6).toUpperCase() || "NOVO";
    
    let msg = `🌸 *Vaidosa Fashion Plus*\n`;
    msg += `━━━━━━━━━━━━━━━━━\n\n`;
    msg += `📋 *${tipo}* #${pedido}\n\n`;
    msg += `📅 *Data:* ${new Date(saleData.date).toLocaleString("pt-BR")}\n`;
    msg += `🏪 *Canal:* ${saleData.channel || "Loja"}\n`;
    msg += `💳 *Pagamento:* ${saleData.pay}${inst?(" " + inst):""}\n\n`;
    
    msg += `🛍️ *ITENS*\n`;
    msg += `━━━━━━━━━━━━━━━━━\n`;
    saleData.items.forEach(it=>{
      const fabric = it.fabric ? ` - ${it.fabric}` : "";
      msg += `• ${it.name} (${it.size})${fabric}\n`;
      msg += `  ${it.qty}x ${fmtBRL(it.price)} = ${fmtBRL(toNum(it.price)*toNum(it.qty))}\n`;
    });
    
    msg += `\n━━━━━━━━━━━━━━━━━\n`;
    msg += `💰 *RESUMO*\n`;
    msg += `Subtotal: ${fmtBRL(saleData.subtotal)}\n`;
    if(toNum(saleData.discount) > 0) msg += `Desconto: ${fmtBRL(saleData.discount)}\n`;
    msg += `\n✨ *TOTAL: ${fmtBRL(saleData.totalBruto)}*\n`;
    
    if(!isOrcamento && sale){
      const status = getSalePaymentStatus(sale);
      const totalPago = sale.payments ? sale.payments.reduce((a,p)=>a+toNum(p.value),0) : 0;
      msg += `\n📊 *Status:* ${status}\n`;
      msg += `✅ *Pago:* ${fmtBRL(totalPago)}\n`;
      if(totalPago < toNum(sale.totalBruto)){
        const restante = toNum(sale.totalBruto) - totalPago;
        msg += `⚠️ *Restante:* ${fmtBRL(restante)}\n`;
      }
    }
    
    if(saleData.note){
      msg += `\n📝 *Obs:* ${saleData.note}\n`;
    }
    
    msg += `\n━━━━━━━━━━━━━━━━━\n`;
    msg += `Obrigada pela preferência! 💕`;

    // Abrir WhatsApp
    const url = `https://wa.me/55${cleanPhone}?text=${encodeURIComponent(msg)}`;
    window.open(url, '_blank');
    
    toast("WhatsApp aberto","Mensagem formatada e pronta para enviar!");
  }

  function getSalePaymentStatus(sale){
    if(!sale.payments || !sale.payments.length) return "Aberto";
    const totalPago = sale.payments.reduce((a,p)=>a+toNum(p.value),0);
    if(totalPago >= toNum(sale.totalBruto)) return "Pago";
    if(totalPago > 0) return "Parcial";
    return "Aberto";
  }

  function renderSalesTable(){
    const tb = document.getElementById("salesTable");
    const list = db.sales.slice(0,80);
    tb.innerHTML = list.map(s=>{
      const c = s.clientId ? findClientById(s.clientId) : null;
      const status = getSalePaymentStatus(s);
      const statusClass = status === "Pago" ? "statusPago" : (status === "Parcial" ? "statusParcial" : "statusAberto");
      const totalPago = s.payments ? s.payments.reduce((a,p)=>a+toNum(p.value),0) : 0;
      
      return `
        <tr>
          <td class="small">${new Date(s.date).toLocaleString("pt-BR")}</td>
          <td>${escapeHtml(c?.name||"Cliente não informado")}</td>
          <td>${escapeHtml(s.channel||"Loja")}</td>
          <td class="${statusClass}">${escapeHtml(status)}</td>
          <td class="right">${fmtBRL(s.totalBruto)}</td>
          <td class="right">${fmtBRL(totalPago)}</td>
          <td class="right">${fmtBRL(s.netReceived||0)}</td>
        </tr>
        <tr>
          <td colspan="7" style="padding:8px 10px;background:#fafbfc;border-bottom:2px solid var(--line)">
            <div style="display:flex;gap:8px;justify-content:flex-end">
              <button class="btn small" style="background:#3b82f6;color:#fff;border-color:#3b82f6" data-pdf="${escapeHtml(s.id)}">PDF</button>
              <button class="btn small" style="background:#10b981;color:#fff;border-color:#10b981" data-whats="${escapeHtml(s.id)}">WhatsApp</button>
              <button class="btn small warn" data-pay="${escapeHtml(s.id)}">Pgto</button>
              <button class="btn small bad" data-del="${escapeHtml(s.id)}">Excluir</button>
            </div>
          </td>
        </tr>
      `;
    }).join("");

    tb.querySelectorAll("button[data-pdf]").forEach(b=>{
      b.addEventListener("click", ()=>{
        const s = db.sales.find(x=>x.id===b.dataset.pdf);
        if(s) generatePDF(s, false);
      });
    });

    tb.querySelectorAll("button[data-whats]").forEach(b=>{
      b.addEventListener("click", ()=>{
        const s = db.sales.find(x=>x.id===b.dataset.whats);
        if(s) sendWhatsApp(s, false);
      });
    });

    tb.querySelectorAll("button[data-pay]").forEach(b=>{
      b.addEventListener("click", ()=>{
        const s = db.sales.find(x=>x.id===b.dataset.pay);
        if(s) openPaymentModal(s);
      });
    });

    tb.querySelectorAll("button[data-del]").forEach(b=>{
      b.addEventListener("click", ()=>{
        if(!confirm("Tem certeza? Isso vai devolver os itens ao estoque.")) return;
        const sid = b.dataset.del;
        deleteSale(sid);
      });
    });
  }

  function deleteSale(saleId){
    const s = db.sales.find(x=>x.id===saleId);
    if(!s) return toast("Não encontrado","Venda não existe.");

    for(const it of s.items){
      const p = db.products.find(x=>x.id===it.productId);
      if(p){
        p.stock = toNum(p.stock) + toNum(it.qty);
        db.stockMoves.unshift({
          id: uid("m"),
          date: nowISO(),
          type: "DEVOLUCAO",
          barcode: p.barcode,
          productId: p.id,
          qty: toNum(it.qty),
          stockAfter: p.stock,
          note: "Venda excluída"
        });
      }
    }

    db.sales = db.sales.filter(x=>x.id!==saleId);
    saveDB("Venda excluída");
    toast("Excluída","Venda removida e estoque devolvido.");
    renderSale();
    renderHome();
  }

  function openPaymentModal(sale){
    currentPaymentSaleId = sale.id;
    const modal = document.getElementById("modalPayments");
    
    const c = sale.clientId ? findClientById(sale.clientId) : null;
    const info = document.getElementById("paymentSaleInfo");
    info.innerHTML = `
      <b>Venda:</b> ${new Date(sale.date).toLocaleString("pt-BR")}<br>
      <b>Cliente:</b> ${escapeHtml(c?.name||"Não informado")}<br>
      <b>Total:</b> ${fmtBRL(sale.totalBruto)}<br>
      <b>Status:</b> ${getSalePaymentStatus(sale)}
    `;

    document.getElementById("payment_date").valueAsDate = new Date();
    document.getElementById("payment_value").value = "";
    document.getElementById("payment_note").value = "";
    document.getElementById("payment_method").value = "PIX";
    document.getElementById("payment_installments").value = "1";
    
    // Controlar exibição do campo de parcelas
    togglePaymentInstallments();

    renderPaymentHistory(sale);
    modal.classList.remove("hide");
  }

  function togglePaymentInstallments(){
    const method = document.getElementById("payment_method").value;
    const container = document.getElementById("payment_installments_container");
    container.style.display = (method === "Credito") ? "block" : "none";
  }

  document.getElementById("payment_method").addEventListener("change", togglePaymentInstallments);

  function closePaymentModal(){
    document.getElementById("modalPayments").classList.add("hide");
    currentPaymentSaleId = null;
  }

  document.getElementById("btnClosePayments").addEventListener("click", closePaymentModal);

  document.getElementById("btnAddPayment").addEventListener("click", ()=>{
    const sale = db.sales.find(s=>s.id===currentPaymentSaleId);
    if(!sale) return;

    const value = toNum(document.getElementById("payment_value").value);
    if(value <= 0) return toast("Valor inválido","Informe um valor maior que zero.");

    const method = document.getElementById("payment_method").value;
    const installments = method === "Credito" ? Number(document.getElementById("payment_installments").value) : 0;
    
    // Calcular taxas se for cartão
    let feeValue = 0;
    let feePct = 0;
    
    if(method === "Debito" || method === "Credito"){
      if(method === "Debito"){
        feePct = 2.99;
      } else {
        // Crédito - taxa varia conforme parcelas
        if(installments <= 1) feePct = 4.99;
        else if(installments <= 6) feePct = 6.99;
        else feePct = 8.99;
      }
      feeValue = (value * feePct) / 100;
    }
    
    const netValue = value - feeValue; // Valor líquido que vai entrar

    const payment = {
      id: uid("pay"),
      date: document.getElementById("payment_date").value || nowISO().slice(0,10),
      value: value,
      method: method,
      installments: installments,
      feePct: feePct,
      feeValue: feeValue,
      netValue: netValue,
      note: document.getElementById("payment_note").value.trim()
    };

    if(!sale.payments) sale.payments = [];
    sale.payments.push(payment);
    
    // Recalcular totais da venda
    const totalPaid = sale.payments.reduce((a,p)=>a+toNum(p.value),0);
    const totalFees = sale.payments.reduce((a,p)=>a+toNum(p.feeValue||0),0);
    const totalNet = sale.payments.reduce((a,p)=>a+toNum(p.netValue||p.value),0);
    
    // Atualizar valores na venda (Opção A: descontar taxa do lucro líquido)
    sale.feeValue = totalFees;
    sale.netReceived = totalNet;
    sale.profit = totalNet - toNum(sale.costTotal||0);

    saveDB("Pagamento");
    toast("Registrado",`Pagamento de ${fmtBRL(value)} adicionado. ${feeValue > 0 ? `Taxa: ${fmtBRL(feeValue)}` : ""}`);
    
    renderPaymentHistory(sale);
    renderSalesTable();
    renderHome();
    
    document.getElementById("payment_value").value = "";
    document.getElementById("payment_note").value = "";
  });

  function renderPaymentHistory(sale){
    const tb = document.getElementById("paymentHistory");
    if(!sale.payments || !sale.payments.length){
      tb.innerHTML = '<tr><td colspan="5" class="muted">Nenhum pagamento registrado</td></tr>';
      return;
    }

    tb.innerHTML = sale.payments.map(p=>{
      const methodDisplay = p.method || "N/A";
      const installmentsDisplay = p.installments > 1 ? ` ${p.installments}x` : "";
      const feeDisplay = p.feeValue > 0 ? fmtBRL(p.feeValue) : "-";
      const netDisplay = p.netValue ? fmtBRL(p.netValue) : fmtBRL(p.value);
      
      return `
        <tr>
          <td class="small">${escapeHtml(p.date)}</td>
          <td class="small">${escapeHtml(methodDisplay)}${installmentsDisplay}</td>
          <td class="right">${fmtBRL(p.value)}</td>
          <td class="right small">${feeDisplay}</td>
          <td class="right">${netDisplay}</td>
        </tr>
      `;
    }).join("");
  }

  function generatePDF(sale, isOrcamento = false){
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF({ unit:"pt", format:"a4" });

    let saleData, c, v, inst;
    
    if(isOrcamento){
      const totals = saleTotals(currentSale);
      const cid = document.getElementById("sale_client").value || "";
      const vid = document.getElementById("sale_vendedor").value || "";
      const pay = document.getElementById("sale_pay").value || "";
      const channel = document.getElementById("sale_channel").value || "Loja";
      const kind = document.getElementById("sale_kind").value || "Venda";
      
      c = cid ? findClientById(cid) : null;
      v = vid ? findVendedorById(vid) : null;
      inst = pay === "CartaoParcelado" ? (document.getElementById("sale_inst").value + "x") : "";
      
      saleData = {
        date: new Date().toISOString(),
        channel,
        kind,
        pay,
        items: currentSale.items,
        note: document.getElementById("sale_note").value.trim(),
        subtotal: totals.sub,
        discount: totals.disc,
        totalBruto: totals.totalBruto,
        feePct: totals.feePct,
        feeValue: totals.feeValue,
        netReceived: totals.net
      };
    } else {
      saleData = sale;
      c = sale.clientId ? findClientById(sale.clientId) : null;
      v = sale.vendedorId ? findVendedorById(sale.vendedorId) : null;
      inst = sale.installments ? (sale.installments + "x") : "";
    }

    const pageWidth = 595;
    let y = 50;

    // ═══════════════════════════════════════
    // CABEÇALHO PROFISSIONAL
    // ═══════════════════════════════════════
    doc.setLineWidth(1.5);
    doc.line(40, y, 555, y); y+=2;
    doc.line(40, y, 555, y); y+=18;

    doc.setFont("helvetica","bold");
    doc.setFontSize(18);
    const empresaNome = "VAIDOSA FASHION PLUS";
    const empresaWidth = doc.getTextWidth(empresaNome);
    doc.text(empresaNome, (pageWidth - empresaWidth) / 2, y); y+=14;

    doc.setFont("helvetica","normal");
    doc.setFontSize(10);
    const slogan = "Moda Plus Size - Tamanhos G1 a G5";
    const sloganWidth = doc.getTextWidth(slogan);
    doc.text(slogan, (pageWidth - sloganWidth) / 2, y); y+=12;

    doc.setLineWidth(1.5);
    doc.line(40, y, 555, y); y+=2;
    doc.line(40, y, 555, y); y+=20;

    // Tipo de documento
    doc.setFont("helvetica","bold");
    doc.setFontSize(14);
    const tipoDoc = isOrcamento ? "ORÇAMENTO" : "RECIBO DE VENDA";
    const numeroDoc = sale?.id ? ` Nº ${sale.id.slice(-6).toUpperCase()}` : "";
    const tituloCompleto = tipoDoc + numeroDoc;
    const tituloWidth = doc.getTextWidth(tituloCompleto);
    doc.text(tituloCompleto, (pageWidth - tituloWidth) / 2, y); y+=20;

    // ═══════════════════════════════════════
    // INFORMAÇÕES DO DOCUMENTO
    // ═══════════════════════════════════════
    doc.setFont("helvetica","normal");
    doc.setFontSize(10);
    
    doc.text(`Data: ${new Date(saleData.date).toLocaleString("pt-BR")}`, 40, y); y+=14;
    
    if(c){
      doc.text(`Cliente: ${c.name}`, 40, y); y+=14;
      if(c.cpf) { doc.text(`CPF: ${c.cpf}`, 40, y); y+=14; }
      if(c.cnpj) { doc.text(`CNPJ: ${c.cnpj}`, 40, y); y+=14; }
      if(c.phone) { doc.text(`Telefone: ${c.phone}`, 40, y); y+=14; }
    } else {
      doc.text(`Cliente: Não informado`, 40, y); y+=14;
    }

    if(v){
      doc.text(`Vendedor(a): ${v.name}`, 40, y); y+=14;
    }

    const paymentLabel = saleData.pay || "Não informado";
    doc.text(`Forma de Pagamento: ${paymentLabel}${inst?(" " + inst):""}`, 40, y); y+=18;

    // Linha separadora
    doc.setLineWidth(0.5);
    doc.setDrawColor(180, 180, 180);
    doc.line(40, y, 555, y); y+=16;

    // ═══════════════════════════════════════
    // ITENS COMPRADOS
    // ═══════════════════════════════════════
    doc.setFont("helvetica","bold");
    doc.setFontSize(11);
    doc.text("ITENS COMPRADOS:", 40, y); y+=16;

    doc.setFont("helvetica","normal");
    doc.setFontSize(10);
    
    saleData.items.forEach((it, idx)=>{
      const itemNum = `${idx + 1}.`;
      const fabric = it.fabric ? ` ${it.fabric}` : "";
      const itemName = `${it.name} (${it.size})${fabric}`;
      const qtd = `${it.qty}x`;
      const priceUnit = fmtBRL(it.price);
      const priceTotal = fmtBRL(toNum(it.price)*toNum(it.qty));
      
      // Linha 1: Número e nome do item
      doc.text(itemNum, 40, y);
      doc.text(itemName, 55, y); y+=14;
      
      // Linha 2: Quantidade e preços com pontilhado
      const qtyPriceText = `   ${qtd} ${priceUnit}`;
      doc.text(qtyPriceText, 40, y);
      
      // Calcular posição do preço total (alinhado à direita)
      const totalWidth = doc.getTextWidth(priceTotal);
      const totalX = 555 - totalWidth;
      
      // Desenhar linha pontilhada
      const dotStartX = 40 + doc.getTextWidth(qtyPriceText) + 10;
      const dotEndX = totalX - 10;
      doc.setLineDash([2, 3]);
      doc.setDrawColor(150, 150, 150);
      doc.line(dotStartX, y - 3, dotEndX, y - 3);
      doc.setLineDash([]);
      
      doc.text(priceTotal, totalX, y);
      y+=18;
      
      if(y>740){ doc.addPage(); y=48; }
    });

    y+=6;
    doc.setLineWidth(0.5);
    doc.setDrawColor(180, 180, 180);
    doc.line(40, y, 555, y); y+=16;

    // ═══════════════════════════════════════
    // RESUMO FINANCEIRO
    // ═══════════════════════════════════════
    doc.setFont("helvetica","normal");
    doc.setFontSize(10);

    const subtotalLabel = "Subtotal";
    const subtotalValue = fmtBRL(saleData.subtotal);
    doc.text(subtotalLabel, 350, y);
    doc.text(subtotalValue, 555 - doc.getTextWidth(subtotalValue), y); y+=14;

    if(toNum(saleData.discount) > 0){
      const descontoLabel = "Desconto";
      const descontoValue = fmtBRL(saleData.discount);
      doc.text(descontoLabel, 350, y);
      doc.text(descontoValue, 555 - doc.getTextWidth(descontoValue), y); y+=14;
    }

    y+=6;
    doc.setFont("helvetica","bold");
    doc.setFontSize(12);
    const totalLabel = "TOTAL";
    const totalValue = fmtBRL(saleData.totalBruto);
    doc.text(totalLabel, 350, y);
    doc.text(totalValue, 555 - doc.getTextWidth(totalValue), y); y+=20;

    doc.setLineWidth(0.5);
    doc.setDrawColor(180, 180, 180);
    doc.line(40, y, 555, y); y+=16;

    // ═══════════════════════════════════════
    // STATUS DE PAGAMENTO (só pra vendas finalizadas)
    // ═══════════════════════════════════════
    if(!isOrcamento && sale){
      doc.setFont("helvetica","bold");
      doc.setFontSize(11);
      doc.text("STATUS DO PAGAMENTO:", 40, y); y+=16;

      const status = getSalePaymentStatus(sale);
      const totalPago = sale.payments ? sale.payments.reduce((a,p)=>a+toNum(p.value),0) : 0;
      
      doc.setFont("helvetica","normal");
      doc.setFontSize(10);
      
      const pagoLabel = "Pago:";
      const pagoValue = fmtBRL(totalPago);
      doc.text(pagoLabel, 40, y);
      doc.text(pagoValue, 555 - doc.getTextWidth(pagoValue), y); y+=14;

      if(totalPago < toNum(sale.totalBruto)){
        const restante = toNum(sale.totalBruto) - totalPago;
        doc.setFont("helvetica","bold");
        const restanteLabel = "Restante a pagar:";
        const restanteValue = fmtBRL(restante);
        doc.text(restanteLabel, 40, y);
        doc.text(restanteValue, 555 - doc.getTextWidth(restanteValue), y); y+=14;
      }

      y+=10;
      doc.setLineWidth(0.5);
      doc.setDrawColor(180, 180, 180);
      doc.line(40, y, 555, y); y+=16;
    }

    // ═══════════════════════════════════════
    // OBSERVAÇÕES
    // ═══════════════════════════════════════
    if(saleData.note){
      doc.setFont("helvetica","bold");
      doc.setFontSize(10);
      doc.text("Observações:", 40, y); y+=14;
      doc.setFont("helvetica","normal");
      const noteLines = doc.splitTextToSize(saleData.note, 515);
      doc.text(noteLines, 40, y);
      y += 14 * noteLines.length + 10;
    }

    // ═══════════════════════════════════════
    // RODAPÉ PROFISSIONAL
    // ═══════════════════════════════════════
    const rodapeY = 780;
    doc.setLineWidth(0.5);
    doc.setDrawColor(180, 180, 180);
    doc.line(40, rodapeY, 555, rodapeY);

    doc.setFont("helvetica","normal");
    doc.setFontSize(9);
    const rodape1 = isOrcamento ? "Orcamento valido por 7 dias." : "Obrigada pela preferencia!";
    const rodape1Width = doc.getTextWidth(rodape1);
    doc.text(rodape1, (pageWidth - rodape1Width) / 2, rodapeY + 12);

    const rodape2 = "Este documento nao e nota fiscal.";
    const rodape2Width = doc.getTextWidth(rodape2);
    doc.text(rodape2, (pageWidth - rodape2Width) / 2, rodapeY + 22);

    const tipo = isOrcamento ? "orcamento" : "venda";
    const file = `vaidosa_${tipo}_${new Date(saleData.date).toISOString().slice(0,10)}_${Date.now().toString(16).slice(-6)}.pdf`;
    doc.save(file);

    const msg = isOrcamento ? "Orçamento gerado" : "PDF gerado";
    toast(msg,"Arquivo baixado no dispositivo.");
  }

  /* =========================
     RELATÓRIOS
  ========================= */
  function renderReportDefaults(){
    const inp = document.getElementById("r_month");
    if(!inp.value){
      const d = new Date();
      inp.value = `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,"0")}`;
    }
    runReport();
  }

  document.getElementById("btnRunReport").addEventListener("click", runReport);
  document.getElementById("r_pay").addEventListener("change", runReport);
  document.getElementById("r_month").addEventListener("change", runReport);
  document.getElementById("r_channel").addEventListener("change", runReport);

  function runReport(){
    const month = document.getElementById("r_month").value;
    if(!month) return;
    const pay = document.getElementById("r_pay").value;
    const ch = document.getElementById("r_channel").value;

    const [Y,M] = month.split("-").map(Number);
    const start = new Date(Y, M-1, 1);
    const end = new Date(Y, M, 1);

    const sales = db.sales.filter(s=>{
      const d = new Date(s.date);
      if(d < start || d >= end) return false;
      if(pay && s.pay !== pay) return false;
      if(ch && (s.channel||"Loja") !== ch) return false;
      return true;
    });

    const bruto = sales.reduce((a,s)=>a+toNum(s.totalBruto),0);
    const taxas = sales.reduce((a,s)=>a+toNum(s.feeValue||0),0);
    const liquido = sales.reduce((a,s)=>a+toNum(s.netReceived||0),0);
    const custo = sales.reduce((a,s)=>a+toNum(s.costTotal||0),0);
    const lucro = liquido - custo;
    const ticket = sales.length ? (bruto / sales.length) : 0;

    const k = document.getElementById("reportKPI");
    k.innerHTML = `
      <div class="box"><div class="t">Vendas</div><div class="v">${sales.length}</div></div>
      <div class="box"><div class="t">Faturamento (bruto)</div><div class="v">${fmtBRL(bruto)}</div></div>
      <div class="box"><div class="t">Taxas</div><div class="v">${fmtBRL(taxas)}</div></div>
      <div class="box"><div class="t">Líquido</div><div class="v">${fmtBRL(liquido)}</div></div>
      <div class="box"><div class="t">Lucro</div><div class="v">${fmtBRL(lucro)}</div></div>
      <div class="box"><div class="t">Ticket médio (bruto)</div><div class="v">${fmtBRL(ticket)}</div></div>
    `;

    const map = new Map();
    for(const s of sales){
      for(const it of s.items){
        const key = it.productId;
        const cur = map.get(key) || { qty:0, bruto:0, liquido:0, it };
        cur.qty += toNum(it.qty);
        cur.bruto += toNum(it.price)*toNum(it.qty);

        const share = (toNum(s.totalBruto) > 0) ? ( (toNum(it.price)*toNum(it.qty)) / toNum(s.totalBruto) ) : 0;
        cur.liquido += toNum(s.netReceived||0) * share;

        map.set(key, cur);
      }
    }

    const top = Array.from(map.values()).sort((a,b)=>b.qty-a.qty).slice(0,50);
    const tb = document.getElementById("topProducts");
    tb.innerHTML = top.map(x=>{
      const p = db.products.find(pp=>pp.id===x.it.productId);
      return `
        <tr>
          <td>${escapeHtml(p?.name || x.it.name)}</td>
          <td class="small">${escapeHtml(p?.barcode || x.it.barcode || "")}</td>
          <td>${escapeHtml(p?.size || x.it.size || "")}</td>
          <td class="right">${toNum(x.qty)}</td>
          <td class="right">${fmtBRL(x.bruto)}</td>
          <td class="right">${fmtBRL(x.liquido)}</td>
        </tr>
      `;
    }).join("");

    const channels = ["Loja","Trafego","WhatsApp","Instagram","Indicacao","Outro"];
    const agg = {};
    channels.forEach(c=>agg[c]={count:0, bruto:0, liquido:0, lucro:0});

    sales.forEach(s=>{
      const cc = s.channel || "Loja";
      if(!agg[cc]) agg[cc] = {count:0, bruto:0, liquido:0, lucro:0};
      agg[cc].count += 1;
      agg[cc].bruto += toNum(s.totalBruto);
      agg[cc].liquido += toNum(s.netReceived||0);
      agg[cc].lucro += (toNum(s.netReceived||0) - toNum(s.costTotal||0));
    });

    const byCh = document.getElementById("byChannel");
    const rows = Object.entries(agg)
      .filter(([k,v])=>v.count>0)
      .sort((a,b)=>b[1].liquido - a[1].liquido)
      .map(([k,v])=>`
        <tr>
          <td>${escapeHtml(k==="Trafego"?"Tráfego pago":k)}</td>
          <td class="right">${v.count}</td>
          <td class="right">${fmtBRL(v.bruto)}</td>
          <td class="right">${fmtBRL(v.liquido)}</td>
          <td class="right">${fmtBRL(v.lucro)}</td>
        </tr>
      `);
    byCh.innerHTML = rows.length ? rows.join("") : `<tr><td colspan="5" class="muted">Sem dados no período.</td></tr>`;
  }

  document.getElementById("btnExportReportPDF").addEventListener("click", exportReportPDF);

  function exportReportPDF(){
    const month = document.getElementById("r_month").value;
    if(!month) return toast("Selecione um mês","Escolha o período do relatório.");
    
    const pay = document.getElementById("r_pay").value;
    const ch = document.getElementById("r_channel").value;

    const [Y,M] = month.split("-").map(Number);
    const start = new Date(Y, M-1, 1);
    const end = new Date(Y, M, 1);

    const sales = db.sales.filter(s=>{
      const d = new Date(s.date);
      if(d < start || d >= end) return false;
      if(pay && s.pay !== pay) return false;
      if(ch && (s.channel||"Loja") !== ch) return false;
      return true;
    });

    const { jsPDF } = window.jspdf;
    const doc = new jsPDF({ unit:"pt", format:"a4" });

    let y = 48;
    doc.setFont("helvetica","bold");
    doc.setFontSize(16);
    doc.text("Vaidosa Fashion Plus - Relatório Mensal", 40, y); y+=24;

    doc.setFont("helvetica","normal");
    doc.setFontSize(11);
    const monthName = new Date(Y, M-1, 1).toLocaleDateString("pt-BR", {month:"long", year:"numeric"});
    doc.text(`Período: ${monthName}`, 40, y); y+=14;
    if(ch) doc.text(`Canal: ${ch==="Trafego"?"Tráfego pago":ch}`, 40, y); y+=14;
    if(pay) doc.text(`Forma de pagamento: ${pay}`, 40, y); y+=14;
    y+=10;

    const bruto = sales.reduce((a,s)=>a+toNum(s.totalBruto),0);
    const taxas = sales.reduce((a,s)=>a+toNum(s.feeValue||0),0);
    const liquido = sales.reduce((a,s)=>a+toNum(s.netReceived||0),0);
    const custo = sales.reduce((a,s)=>a+toNum(s.costTotal||0),0);
    const lucro = liquido - custo;
    const ticket = sales.length ? (bruto / sales.length) : 0;

    doc.setFont("helvetica","bold");
    doc.setFontSize(12);
    doc.text("Resumo Financeiro", 40, y); y+=16;

    doc.setFont("helvetica","normal");
    doc.setFontSize(10);
    doc.text(`Total de vendas: ${sales.length}`, 40, y); y+=14;
    doc.text(`Faturamento bruto: ${fmtBRL(bruto)}`, 40, y); y+=14;
    doc.text(`Taxas de cartão: ${fmtBRL(taxas)}`, 40, y); y+=14;
    doc.text(`Líquido recebido: ${fmtBRL(liquido)}`, 40, y); y+=14;
    doc.text(`Lucro estimado: ${fmtBRL(lucro)}`, 40, y); y+=14;
    doc.text(`Ticket médio: ${fmtBRL(ticket)}`, 40, y); y+=20;

    // Vendas por canal
    doc.setFont("helvetica","bold");
    doc.setFontSize(12);
    doc.text("Vendas por Canal", 40, y); y+=16;

    const channels = ["Loja","Trafego","WhatsApp","Instagram","Indicacao","Outro"];
    const agg = {};
    channels.forEach(c=>agg[c]={count:0, bruto:0, liquido:0, lucro:0});

    sales.forEach(s=>{
      const cc = s.channel || "Loja";
      if(!agg[cc]) agg[cc] = {count:0, bruto:0, liquido:0, lucro:0};
      agg[cc].count += 1;
      agg[cc].bruto += toNum(s.totalBruto);
      agg[cc].liquido += toNum(s.netReceived||0);
      agg[cc].lucro += (toNum(s.netReceived||0) - toNum(s.costTotal||0));
    });

    doc.setFont("helvetica","normal");
    doc.setFontSize(9);
    Object.entries(agg)
      .filter(([k,v])=>v.count>0)
      .sort((a,b)=>b[1].liquido - a[1].liquido)
      .forEach(([k,v])=>{
        const channelName = k==="Trafego"?"Tráfego pago":k;
        doc.text(`${channelName}: ${v.count} vendas | Bruto: ${fmtBRL(v.bruto)} | Líquido: ${fmtBRL(v.liquido)} | Lucro: ${fmtBRL(v.lucro)}`, 40, y);
        y+=12;
        if(y>760){ doc.addPage(); y=48; }
      });

    y+=10;

    // Vendas por forma de pagamento
    doc.setFont("helvetica","bold");
    doc.setFontSize(12);
    doc.text("Vendas por Forma de Pagamento", 40, y); y+=16;

    const payTypes = {};
    sales.forEach(s=>{
      const pt = s.pay || "PIX";
      if(!payTypes[pt]) payTypes[pt] = {count:0, bruto:0, liquido:0};
      payTypes[pt].count += 1;
      payTypes[pt].bruto += toNum(s.totalBruto);
      payTypes[pt].liquido += toNum(s.netReceived||0);
    });

    doc.setFont("helvetica","normal");
    doc.setFontSize(9);
    Object.entries(payTypes)
      .sort((a,b)=>b[1].liquido - a[1].liquido)
      .forEach(([k,v])=>{
        doc.text(`${k}: ${v.count} vendas | Bruto: ${fmtBRL(v.bruto)} | Líquido: ${fmtBRL(v.liquido)}`, 40, y);
        y+=12;
        if(y>760){ doc.addPage(); y=48; }
      });

    y+=10;

    // Top produtos
    doc.setFont("helvetica","bold");
    doc.setFontSize(12);
    doc.text("Top 10 Produtos Mais Vendidos", 40, y); y+=16;

    const map = new Map();
    for(const s of sales){
      for(const it of s.items){
        const key = it.productId;
        const cur = map.get(key) || { qty:0, bruto:0, liquido:0, it };
        cur.qty += toNum(it.qty);
        cur.bruto += toNum(it.price)*toNum(it.qty);
        const share = (toNum(s.totalBruto) > 0) ? ( (toNum(it.price)*toNum(it.qty)) / toNum(s.totalBruto) ) : 0;
        cur.liquido += toNum(s.netReceived||0) * share;
        map.set(key, cur);
      }
    }

    const top = Array.from(map.values()).sort((a,b)=>b.qty-a.qty).slice(0,10);
    
    doc.setFont("helvetica","normal");
    doc.setFontSize(9);
    top.forEach((x,idx)=>{
      const p = db.products.find(pp=>pp.id===x.it.productId);
      const name = p?.name || x.it.name;
      const size = p?.size || x.it.size || "";
      doc.text(`${idx+1}. ${name} (${size}): ${toNum(x.qty)} unid | Bruto: ${fmtBRL(x.bruto)} | Líquido: ${fmtBRL(x.liquido)}`, 40, y);
      y+=12;
      if(y>760){ doc.addPage(); y=48; }
    });

    doc.setFont("helvetica","normal");
    doc.setFontSize(8);
    doc.text(`Relatório gerado em ${new Date().toLocaleString("pt-BR")}`, 40, 810);

    const file = `vaidosa_relatorio_${month}.pdf`;
    doc.save(file);

    toast("Relatório exportado","PDF baixado com sucesso.");
  }

  /* =========================
     BACKUP: BOTÕES + SETTINGS
  ========================= */
  document.getElementById("btnAutoBackupEnable").addEventListener("click", chooseAutoBackupFile);
  document.getElementById("btnAutoBackupDisable").addEventListener("click", disableAutoBackup);
  document.getElementById("btnAutoBackupNow").addEventListener("click", ()=>backupNow("Manual"));

  document.getElementById("blockSecondSwap").addEventListener("change", ()=>{
    settings.blockSecondSwap = !!document.getElementById("blockSecondSwap").checked;
    saveSettings(settings);
    toast("Configuração salva","Bloqueio de 2ª troca atualizado.");
  });

  document.getElementById("btnExport").addEventListener("click", ()=>{
    const data = JSON.stringify(db, null, 2);
    const blob = new Blob([data], { type:"application/json" });
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = `vaidosa_backup_${new Date().toISOString().slice(0,10)}.json`;
    a.click();
    URL.revokeObjectURL(url);
    toast("Backup gerado","Arquivo baixado.");
  });

  document.getElementById("btnImport").addEventListener("click", async ()=>{
    const f = document.getElementById("fileImport").files?.[0];
    if(!f) return toast("Selecione um arquivo","Escolha um JSON de backup.");
    const txt = await f.text();
    try{
      const obj = JSON.parse(txt);
      if(!obj.products || !obj.clients || !obj.sales || !obj.stockMoves) throw new Error("Estrutura inválida");
      if(!obj.vendedores) obj.vendedores = [];
      db = obj;
      saveDB("Import");
      toast("Importado","Dados restaurados.");
      currentSale = { items:[], finalizedSaleId:null };
      selectedProductId=null;
      selectedClientId=null;
      renderHome(); renderProducts(); renderClients(); renderVendedores(); renderStock(); renderSale(); runReport();
    }catch(e){
      toast("Falhou","Backup inválido.");
    }
  });

  document.getElementById("btnWipe").addEventListener("click", ()=>{
    if(!confirm("ATENÇÃO: Isso vai apagar TUDO. Tem certeza?")) return;
    localStorage.removeItem(KEY);
    db = loadDB();
    saveDB("Wipe");
    currentSale = { items:[], finalizedSaleId:null };
    selectedProductId=null;
    selectedClientId=null;
    toast("Zerado","Banco limpo.");
    renderHome();
  });

  document.getElementById("btnResetCounter").addEventListener("click", ()=>{
    const newStart = prompt("Iniciar contador em qual número? (ex: 1 para VF000001)", "1");
    if(!newStart) return;
    const num = parseInt(newStart);
    if(isNaN(num) || num < 0) return toast("Inválido","Digite um número válido.");
    saveCodeCounter(num - 1);
    document.getElementById("lastCodeGenerated").textContent = getLastGeneratedCode();
    toast("Contador redefinido",`Próximo código será: VF${String(num).padStart(6,"0")}`);
  });

  /* =========================
     INIT
  ========================= */
  setTab("venda");
  renderHome();
  renderProducts();
  renderClients();
  renderVendedores();
  renderStock();
  renderReportDefaults();

  if(document.getElementById("lastCodeGenerated")){
    document.getElementById("lastCodeGenerated").textContent = getLastGeneratedCode();
  }

  (async ()=>{ try{ await initAutoBackup(); }catch{} })();
</script>

</div>
</body>
</html>
